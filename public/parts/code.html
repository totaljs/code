<div id="panel">
	<section class="project exec" data-exec="code/projects" data-bind="code.data__template">
		<script type="text/html">
			{{ if value }}
			<i class="ti ti-angle-down"></i><b>{{ value.name }}</b><div>@(Branch:) {{ value.branch | empty('@(Master)') }}</div>
			{{ else }}
			<i class="ti ti-angle-down"></i><b>@(Choose project)</b><div><i class="ti ti-thumbs-up mr5"></i>@(Thank you for using Total.js)</div>
			{{ fi }}
		</script>
	</section>
	<div>
		<div data-bind="common.recent__template__|__code.data__hide" class="hidden">
			<script type="text/html">
				{{ foreach m in value }}
				<div data-id="{{ m.id }}" class="recent exec" data-exec="code/loadproject"><i class="ti ti-code-branch mr5"></i>{{ m.name }}</div>
				{{ end }}
			</script>
		</div>
		<div data---="viewbox__code.tree__scrollbar:1;parent:.ui-dockable-body;margin:86;visibleY:0;scrollbarshadow:1" data-bind="code.data__show" class="hidden">
			<div class="changedfiles hidden" data-bind="code.recent__template__show:value && value.length">
				<script type="text/html">
					<div><i class="ti ti-clock"></i>@(Last changed files)</div>
					<div>
					{{ foreach m in value }}
						<div class="changefile">
							<div class="path exec" data-exec="code/editpath" data-path="{{ m.path }}">{{ if m.changes }}<span>+{{ m.changes }}</span>{{ fi }}<i class="ti ti-file"></i>{{ m.path }}</div>
						</div>
					{{ end }}
					</div>
				</script>
			</div>
			<div data---="tree__code.tree__exec:code/open;options:code/options;rename:code/rename;first:false;upload:code/upload;pk:path;extrabutton:code/templates;extralabel:@(Download template)"></div>
		</div>
	</div>

	<section class="status invisible" data-bind="code.data__visible">
		<button title="@(Create file)" class="exec" data-name="file" data-exec="code/statusform"><i class="ti ti-file"></i></button>
		<button title="@(Create folder)" class="exec" data-name="directory" data-exec="code/statusform"><i class="ti ti-folder"></i></button>
		<button title="@(Refresh directories and files)" class="exec" data-exec="code/refresh"><i class="ti ti-refresh"></i></button>
		<button title="@(Time spent)" class="exec" data-exec="code/timespent"><i class="ti ti-calendar"></i></button>
		<button title="@(All tracked changes)" class="exec" data-exec="code/changes"><i class="ti ti-history"></i></button>
		<button title="@(Users)" class="exec" data-name="directory" data-exec="code/usersonline"><i class="ti ti-users"></i></button>
	</section>
</div>

<div data---="dockable__code.dock__margin:[dockmargin]">
	<div id="body">

		<div id="currentcolor" class="hidden"><span>B</span><span>W</span></div>
		<div id="currenticon" class="hidden"></div>

		<div id="combo" data---="combo__editor.combo" data-bind="code.editor.path__show:code/showcombo" class="hidden" title="@(Scoreboard for the project)">
			<div class="info">
				<div>@(COMBO)</div>
				<b>0</b>
				<div class="progress"></div>
			</div>
			<div class="rating"></div>
		</div>

		<div class="body-title">@(Total.js Code Editor v)<span data-bind="common.version__text"></span></div>
		<section class="tabs">
			<span class="livereloadindicator hidden" data-bind="code.data.livereload__show"><i class="ti ti-circle-alt green"></i></span>
			<span data-bind="code.data.id__show" class="docker exec" data-exec="code/docker" title="@(Docker)"><i class="ti ti-docker"></i></span>
			<a data-bind="code.data.url__href__show" target="_blank" class="preview" title="@(Preview)"><i class="ti ti-globe"></i></a>
			<span class="options exec hidden" data-bind="code.editor__show" data-exec="code/options_editor"><i class="ti ti-cog-alt"></i></span>
			<span class="options2 exec hidden" data-bind="code.editor__show" data-exec="code/branches"><i class="ti ti-code-branch"></i></span>
			<nav data---="tabmenu__code.editor.path__datasource:code.open;selector:span;exec:code/opentab;reorder:code/savetabs">
				<script type="text/html">
					<span data-value="{{ path }}" class="{{ if !skip }}nolocked{{ fi }}{{ if modified }} modified{{ fi }}" title="{{ path }}"><i class="{{ name | fileicon }} exec" data-exec="code/close"></i>{{ name }}</span>
				</script>
			</nav>
		</section>
		<div data-bind="code.editor.path__visible" class="invisible">
			<div class="search">
				<span class="label"><i class="ti ti-search"></i>@(Search)</span>
				<nav>
					<button class="search-cancel hidden" name="clear" title="@(Clear search)"><i class="ti ti-times red"></i></button>
					<button class="search-op" name="prev" disabled="disabled" title="@(Previous result)"><i class="ti ti-angle-up"></i></button>
					<button class="search-op" name="next" disabled="disabled" title="@(Next result)"><i class="ti ti-angle-down"></i></button>
				</nav>
				<span class="count hidden"></span>
				<div><input type="text" maxlength="100" placeholder="@(Type to search and press enter)" /></div>
			</div>
		</div>
		<div id="content">
			<div class="alert-saved hidden exec" data-bind="code.saved__show__html b" data-exec="code/syncsave"><i class="ti ti-warning"></i><b></b> @(has replaced content of this file on the server.)</div>
			<div data-bind="code.editor.path__show" class="codeeditor">
				<div data---="editor__code.editor.body__height:100%;pk:path;change:code/changedcode;shortcut:code/shortcut;contextmenu:code/contextmenu;cursor:code/cursorposition;sync:code/sync;todo:code/todo;components:code/components;combo:code/combo"></div>
			</div>
			<div class="messages">
				<div class="alert hidden" data-bind="code.backup__show" data-name="backup"><i class="ti ti-times exec" data-exec="code/warning"></i><i class="ti ti-warning"></i>@(The content of this file wasn't saved before. Do you want to restore it?) <span class="link exec" data-name="restore" data-exec="code/warning">@(Restore)</span> @(or) <span class="link exec" data-exec="code/warning">@(Cancel)</span>.</div>
				<div class="alert hidden" data-bind="code.multiple__show" data-name="multiple" style="z-index:1001"><i class="ti ti-times exec" data-exec="code/warning"></i><i class="ti ti-users"></i>@(Be careful because another user is editing content of this file.) <span class="link exec b ml5" data-exec="code/syncdata"><i class="ti ti-refresh ti-spin mr5"></i>@(Synchronize)</span> @(or) <span class="link exec" data-exec="code/warning">@(Cancel)</span>.</div>
			</div>
		</div>

		<div data-bind="code.fileversion__text__show" class="fileversion"></div>

		<div data-bind="code.colorpalette__template" class="colorpalette">
			<script type="text/html">
				{{ foreach m in value }}
					<span class="exec" data-exec="code/appendcolor" data-color="{{ m }}" title="{{ m }}" style="background-color:{{ m }}"></span>
				{{ end }}
			</script>
		</div>

	</div>

	<section class="status invisible" data-bind="code.data__invisible:!value">
		<div data-bind="code.usersproject__template" class="status-collaborators">
			<script type="text/html">
				{{ foreach m in value }}
					{{ m.name | initials }}
				{{ end }}
			</script>
		</div>
		<div data-bind="code.errors__html b:value?value.length:0__.red:value && value.length>0" class="status-alerts exec" data-exec="code/warnings">
			<i class="ti ti-warning"></i><b>0</b>
		</div>
		<div class="status-diff" data-bind="code.current.changes__disabled button:!value||!value.length__click button:code/diff__text b:value?value.length:0">
			<button name="prev" title="@(Previous change)"><i class="ti ti-chevron-left"></i></button>
			<span title="@(Count of changed lines)"><i class="ti ti-plus green"></i><b>0</b></span>
			<button name="next" title="@(Next change)"><i class="ti ti-chevron-right"></i></button>
		</div>
		<div class="status-modified exec" data-bind="code.current.lastmodified__template__show" data-path="common.form" data-value="'backups'">
			<script type="text/html">
				{{ if value && value.updated }}
					{{ value.user | initials }}
				 	<div><i class="ti ti-history"></i><b title="{{ value.updated | format('[date]') }}" class="time" data-time="{{ value.updated | utc }}">{{ value.updated | time }}</b></div>
				{{ fi }}
			</script>
		</div>
		<div class="status-meta" data-bind="code.editor.body__html:code/statusmeta__delay:500">---</div>
		<div class="status-info" data-bind="code.cursor__exec:code/statusinfo" title="@(Line : Char index : Selected chars)"></div>
		<div class="status-path" data-bind="code.editor.path__text"></div>
	</section>

	<div data---="statusform__code.statusform.name__exec:code/statusform" class="statusform hidden">
		<div class="statusform-item hidden" data-name="file">
			<input type="text" placeholder="@(Enter relative filename.js)" />
		</div>
		<div class="statusform-item hidden" data-name="directory">
			<input type="text" placeholder="@(Enter relative folder name)" />
		</div>
	</div>

</div>

<div class="collaborators" data-bind="code.editor.path__show .onlyopen__|__code.data__show">
	<div class="tools">
		<a data-bind="code.data.id__href:'/pause/?url=' + encodeURIComponent('/?id=' + (value || ''))" title="@(Pause / Time to Relax)" class="red pause"><i class="ti ti-pause"></i></a>
		<span title="@(To-Do list)" class="exec" data-path="common.form" data-value="'tasks'"><b class="uncomplete" data-bind="code.data.todo --> code/codetasks_unsolved__show__html"></b><i class="ti ti-tasks"></i></span>
		<span title="@(Code review)" data-bind="code.editor.path__show" class="hidden exec review onlyopen" data-exec="code/review"><i class="ti ti-check"></i></span>
	</div>
	<section data-bind="code.usersfile__template" class="onlyopen">
		<script type="text/html">
			{{ foreach m in value }}
				{{ m.name | initials }}
			{{ end }}
		</script>
	</section>
</div>

<div id="panel_prop">
	<div class="options">
		<ul class="tabbuttons" data---="tabmenu__common.form">
			<li data-value="components" title="@(Used parts)"><i class="ti ti-puzzle"></i></li>
			<li data-value="componentator" title="@(UI components)"><i class="ti ti-totaljs"></i></li>
			<li data-value="output" title="@(Output panel)"><i class="ti ti-rss-square"></i></li>
			<li data-value="search" title="@(Search)"><i class="ti ti-search"></i></li>
			<li data-value="changes" title="@(Last changes)"><i class="ti ti-history"></i></li>
			<li data-value="backups" title="@(Backups)"><i class="ti ti-archive"></i></li>
			<li data-value="timespentform" title="@(Time spent)"><i class="ti ti-clock"></i></li>
		</ul>
	</div>
	<div data---="part__common.form__if:search;url:/forms/search.html;reload:codesearch/reload"></div>
	<div data---="part__common.form__if:tasks;url:/forms/tasks.html;reload:codetasks/reload"></div>
	<div data---="part__common.form__if:backups;url:/forms/backups.html;reload:codebackups/reload"></div>
	<div data---="part__common.form__if:changes;url:/forms/changes.html;reload:codechanges/reload"></div>
	<div data---="part__common.form__if:componentator;url:/forms/componentator.html;reload:componentator/reload"></div>
	<div data---="part__common.form__if:components;url:/forms/components.html;reload:components/reload"></div>
	<div data---="part__common.form__if:output;url:/forms/output.html;reload:output/reload"></div>
	<div data---="part__common.form__if:timespentform;url:/forms/timespent.html;reload:timespentform/reload"></div>
	<div data---="part__common.form__if:bundles;url:/forms/bundles.html;reload:bundlespanel/reload"></div>
	<div data---="part__common.form__if:templates;url:/forms/templates.html;reload:templatespanel/reload"></div>
	<div data---="part__common.form__if:packages;url:/forms/packages.html;reload:packagespanel/reload"></div>
	<div data---="part__common.form__if:modules;url:/forms/modules.html;reload:modulespanel/reload"></div>
	<div data---="part__common.form__if:schemas;url:/forms/schemas.html;reload:schemaspanel/reload"></div>
	<div data---="part__common.form__if:operations;url:/forms/operations.html;reload:operationspanel/reload"></div>
	<div data---="part__common.form__if:definitions;url:/forms/definitions.html;reload:definitionspanel/reload"></div>
</div>

<div data---="importer__common.top__if:branches;url:/forms/branches.html"></div>
<div data---="importer__common.form__if:formlocalize;url:/forms/localize.html"></div>

<script>

	var code = { SYNC: false, changes: {}, NOTRIM: { nosql: 1, table: 1, todo: 1, issyncing: false }, dock: [], ready: false };

	code.dock.push({ id: 'project', title: '@(Project)', html: $('#panel'), offset: { x: 200, y: 200, width: 241, minwidth: 200, minheight: 500, dockminwidth: 192, dockmaxwidth: 600, docked: 'left' }, actions: { autosave: true, close: false, dockable: 'left right' }});
	code.dock.push({ id: 'prop', title: '@(Additional)', html: $('#panel_prop'), hidden: true, offset: { x: 200, y: 200, width: 350, minwidth: 200, minheight: 500, dockminwidth: 200, dockmaxwidth: 600, docked: 'right' }, actions: { autosave: true, close: false, hide: true, dockable: 'left right' }});

	function rendertemplate(body) {
		var helpers = {};
		var strhelpers = '';
		var model = EMPTYOBJECT;
		var beg = body.indexOf('<scr' + 'ipt>');
		var end;

		// helpers
		if (beg !== -1) {
			end = body.indexOf('</scr' + 'ipt>', beg + 8);
			strhelpers = body.substring(beg + 8, end).trim();
			body = body.substring(0, beg) + body.substring(end + 9);
		}

		// model
		beg = body.indexOf('<scr' + 'ipt type="text/json">');
		if (beg !== -1) {
			end = body.indexOf('</scr' + 'ipt>', beg + 8);
			model = PARSE(body.substring(beg + 25, end).trim());
			body = body.substring(0, beg) + body.substring(end + 9);
		}

		if (strhelpers)
			new Function('Thelpers', strhelpers)(helpers);

		var output = Tangular.render(body, { value: model }, null, helpers);
		var ismd = (/<(html|body|div|span|b|em|strong|h1|h2|h3|img)/i).test(body) === false;

		if (ismd)
			output = `<!DOCTYPE html><html><head><title>{0}</title><meta charset="utf-8" /><link href="https://cdn.componentator.com/spa.min@20.css" rel="stylesheet" type="text/css" /><style>.markdown-small .markdown{font-size:14px;line-height:20px}.markdown{font-size:16px;line-height:22px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';color:#404040;overflow:hidden;padding:0}.markdown-container > *:last-child{margin-bottom:0}.markdown code{font-family:'SFMono-Regular',Consolas,'Liberation Mono',Menlo,Courier,monospace;white-space:pre}.markdown h1{cursor:default;margin:0 0 20px;font-size:30px;padding:0 0 13px;border-bottom:1px solid #E0E0E0;color:#000;line-height:38px;font-family:-apple-systm,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';font-weight:normal;line-height:32px;font-weight:bold}.markdown h2{cursor:default;margin:0 0 18px;font-weight:bold;font-size:25px;padding:0 0 8px;border-bottom:1px solid #E0E0E0;color:#000;line-height:28px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol'}.markdown h3{cursor:default;margin:0 0 10px;font-size:20px;padding:0 0 5px;color:#404040;font-weight:bold;line-height:22px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol'}.markdown h4,.markdown h5{cursor:default;margin:0 0 10px;font-size:17px;color:#404040;font-weight:bold;line-height:22px;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Helvetica,Arial,sans-serif,'Apple Color Emoji','Segoe UI Emoji','Segoe UI Symbol';background-color:#F0F0F0;padding:4px 3px;border-radius:var(--radius);border-bottom:1px solid #E0E0E0}.markdown p{margin:0 0 15px;padding-left:0;padding-right:0}.markdown p code,.markdown li code,.markdown section code,.markdown blockquote code,.markdown h1 code,.markdown h2 code,.markdown h3 code,.markdown h4 code,.markdown td code{background-color:#E0E0E0;padding:1px 4px 2px;border-radius:var(--radius);font-size:14px}.markdown p code,.markdown section code,.markdown li code,.markdown blockquote code,.markdown td code{border:1px solid #E0E0E0;background-color:#F5F5F5}.markdown pre{padding:0;border-radius:var(--radius);margin:20px 0;width:100%}.markdown pre code{padding:10px;font-size:14px;line-height:18px;overflow-scrolling:touch;border-radius:var(--radius)}.markdown table{margin:0 0 15px;width:auto !important}.markdown ul{margin:0 0 20px 0;padding:0 0 0 2em}.markdown ul ul{margin-bottom:0}.markdown img{max-width:100%}.markdown th{background-color:#F8F8F8}.markdown blockquote{padding:15px 20px;background-color:#F0F0F0;margin:10px 0 20px;border-radius:var(--radius)}.markdown section{padding:15px 20px;background-color:#FFFED1;margin:10px 0 15px;border-radius:var(--radius)}.markdown hr{border-color:#E0E0E0;border-width:2px}.markdown-line2{border-width:4px !important;margin:15px 0 30px !important}.markdown h1 code{font-size:28px;font-weight:normal;background-color:#DAE8F8}.markdown h2 code{font-size:23px;font-weight:normal;background-color:#DAE8F8}.markdown h3 code{font-size:18px;font-weight:normal;background-color:#DAE8F8}.markdown h4 code{font-size:17px;font-weight:normal;background-color:#DAE8F8}.markdown a code{background-color:#DAE8F8;text-decoration:none !important;border-color:#D5DFEB}.markdown-footnote{background-color:rgba(0,0,0,0.1);padding:0 2px;border-radius:var(--radius);cursor:help}.markdown-footnotebody{font-size:11px;border-top:1px solid #E0E0E0;font-family:Arial;color:#505050}.markdown-showsecret{cursor:pointer;display:block;padding:8px 15px;user-select:none;font-size:14px}.markdown-showsecret b{margin-left:8px}.markdown-showsecret .pull-right{margin:2px 0 0}.markdown-secret{padding:0;border-radius:var(--radius);border:1px solid #E0E0E0}.markdown-secret > div{padding:15px 15px 1px;border-radius:0 0 var(--radius) var(--radius);background-color:#F8F8F8}.markdown-small p code,.markdown-small li code,.markdown-small section code,.markdown-small blockquote code,.markdown-small td code,.markdown-small pre code{font-size:12px}.markdown-task > i:first-child{margin-right:5px}.markdown-code{margin-bottom:15px}.markdown-block{margin:0}.markdown-block:last-child{margin-bottom:15px}.markdown-block > div{padding:10px 10px 1px;border:1px solid #E0E0E0;margin:10px 0;border-radius:var(--radius)}.markdown-block > div > *:last-child{margin-bottom:10px}.markdown-showblock{cursor:pointer;display:block;padding:3px 0;user-select:none;border-bottom:1px solid #E0E0E0}.markdown-showblock i{width:16px;font-size:12px;padding:6px 0 0;float:left}.markdown-showblock-visible{border-bottom:0}.markdown-video{position:relative;padding-bottom:56.25%;padding-top:25px;height:0;margin-bottom:15px}.markdown-video iframe{position:absolute;top:0;left:0;width:100%;height:100%}.markdown-small p,.markdown-small section,.markdown-small blockquote,.markdown-small table,.markdown-small .markdown-code{margin-bottom:10px}.ui-dark .markdown{color:#C0C0C0}.ui-dark .markdown blockquote{color:#FFF;background-color:#444}.ui-dark .markdown th{background-color:#404040}.ui-dark .markdown h2{color:#FFF;border-bottom-color:#404040}.ui-dark .markdown h1{color:#FFF;border-bottom-color:#404040}.ui-dark .markdown h1 code{background-color:#404040}.ui-dark .markdown hr{border-color:#404040}.ui-dark .markdown h2 code{background-color:#404040}.ui-dark .markdown h3 code{background-color:#404040}.ui-dark .markdown h4 code{background-color:#404040}.ui-dark .markdown section{background-color:#6d6c52}.ui-dark .markdown a code{background-color:#303030;border-color:#454545}.ui-dark .markdown h4,.ui-dark .markdown h5{color:#C0C0C0;background-color:#505050;border-bottom:1px solid #404040}.ui-dark .markdown p code,.ui-dark .markdown section code,.ui-dark .markdown li code,.ui-dark .markdown blockquote code,.ui-dark .markdown td code{border-color:#404040;background-color:#505050}.ui-dark .markdown-footnote{background-color:rgba(255,255,255,0.1)}.ui-dark .markdown-footnotebody{border-top-color:#505050;color:#888}.ui-dark .markdown-block > div,.ui-dark .markdown-showblock{border-color:#404040}.ui-dark .markdown-secret{border:1px solid #404040}.ui-dark .markdown-secret > div{background-color:#303030}</style></head><body><div style="max-width:900px;margin:30px auto;width:100%">{1}</div></body></html>`.format(name, output.markdown());

		if (!output.includes('<html>'))
			output = `<!DOCTYPE html><html><head><title>{0}</title><meta charset="utf-8" /><link href="https://cdn.componentator.com/spa.min@20.css" rel="stylesheet" type="text/css" /></head><body>{1}</body></html>`.format(name, output);

		SETTER('iframeviewer/open', { name: 'Preview template', esc: true, html: output.replace(/~CDN~/g, 'https://cdn.componentator.com') });
	}

	PLUGIN('code', function(exports) {

		code.cursor = { TYPE: 'synccur', id: user.id, connid: common.id };

		var editor;
		var cache_scrollpos = {};
		var reg_number = /^\d+$/;
		var maxtyping = 0;
		var combo = null;

		FIND('editor', function(com) {
			exports.editor = editor = com;
		});

		FIND('combo', function(com) {
			combo = com;
		});

		exports.branches = function() {
			if (code.data.isexternal)
				SETTER('message/warning', '@(External projects can\'t use branches)');
			else
				SET('common.top', 'branches');
		};

		exports.showcombo = function(value) {
			return !!value && !!common.powermode;
		};

		exports.combo = function() {

			var old = code.lastchange;
			code.lastchange = Date.now();

			if (old) {
				old = code.lastchange - old;
				if (old && old < 150) {
					if (maxtyping++ > 15)
						return;
				} else if (old > 1000) // 1 second delay
					maxtyping = 0;
			}

			common.powermode && combo && combo.combo();
		};

		exports.refresh = function(callback) {
			exports.load(code.data.id, true, callback);
		};

		exports.messenger = function() {
			var obj = {};
			obj.id = 'messenger';
			obj.offset = { x: 600, y: 300, width: 600, height: 400, minwidth: 200, minheight: 200 };
			obj.title = '<i class="ti ti-support"></i>@(Chat support with contributors)';
			var meta = $.param({ token: common.token, nick: user.name, position: user.position, darkmode: $(document.body).hclass('td') ? 1 : 0, reference: user.id, source: location.hostname });
			obj.html = '<div class="messenger"><{1} src="{0}" frameborder="0" scrolling="no" allowtransparency="true" allow="geolocation *; microphone *; camera *; midi *; encrypted-media *"></{1}></div>'.format('https://support.totaljs.com/?' + meta, 'iframe'); // common.electron ? 'webview' : 'iframe');
			obj.actions = { minimize: true, maximize: true, move: true, resize: true, close: true, autosave: true };
			PUSH('windows', obj);
		};

		exports.showselected = function() {
			var editor = EDITOR.editor;
			var obj = {};
			obj.id = 'selected_' + GUID(10);
			obj.offset = { x: 600, y: 300, width: 450, height: 300, minwidth: 200, minheight: 200 };
			obj.cachekey = 'selected';
			obj.title = '<i class="ti ti-font"></i>@(Selected text: <b>{0}</b>)'.format(code.current.name);

			var el = document.createElement('PRE');
			var cur = editor.getModeAt(editor.getCursor());
			var t = cur.helperType || cur.name;
			if (t === 'json')
				t = 'application/ld+json';

			CodeMirror.runMode(FUNC.strim(editor.getSelections().join('\n')).replace(/\t/g, '    '), t, el);
			obj.html = '<div style="height:100%;overflow:auto;padding:0 15px" class="noscrollbar"><div class=""><pre class="cm-s-default" style="overflow:hidden">' + el.innerHTML + '</pre></div></div>';
			obj.actions = { minimize: false, maximize: false, move: true, resize: true, close: true, autosave: false };
			PUSH('windows', obj);
		};

		exports.statusmeta = function(value, path, el) {
			var bytes = FUNC.bytelength(value);
			var size = Thelpers.filesize(bytes);
			var isbig = bytes > 30000;
			el.tclass('red b', isbig);
			return value ? (isbig ? '<i class="ti ti-exclamation-circle mr5"></i>' : '') + size + ' / ' + FUNC.newlineslength(value).pluralize('@(# lines,# line,# lines,# lines)') : DEF.empty;
		};

		var statusinfo = function(obj) {
			var value = obj.value;
			var sel = ((value.tch || 0) - (value.fch || 0));
			var plus = '';
			var iconel = $('#currenticon');
			var iconis = false;

			if (sel && editor) {
				var text = editor.editor.getSelection();
				var l = text.length - 1;
				plus = text.charAt(l) + ' = <code>{0}</code>'.format(text.charCodeAt(l));
				if (reg_number.test(text) && (+text) > 32)
					plus += (plus ? ' ' : '') + text + ' = <code>{0}</code>'.format(String.fromCharCode(text));

				var icon = text.match(/fa(s|d|b|l|r)?\sfa-[a-z0-9\-]+|fa-[a-z0-9\-]+\sfa(s|d|b|l|r)/);
				if (icon) {
					iconel.rclass('hidden').html('<i class="{0}"></i>'.format(icon[0]));
					iconis = true;
				} else {
					icon = text.match(/ti?\sti-[a-z0-9\-]+|fa-[a-z0-9\-]+\sti/);
					if (icon) {
						iconel.rclass('hidden').html('<i class="{0}"></i>'.format(icon[0]));
						iconis = true;
					}
				}
			}

			if (!iconis)
				iconel.aclass('hidden');

			obj.el.html(((value.fline || 0) + 1) + ':' + (value.fch || 0) + (value.fline === value.tline ? (':' + sel) : '') + (plus ? (' ' + plus) : ''));
		};

		exports.statusinfo = function(value, path, el) {
			setTimeout2('code_statusinfo', statusinfo, 300, null, { value: value, el: el });
		};

		exports.components = function(components) {

			var is = components.length > 0;
			var checksum = HASH(components);
			if (checksum === code.componentschecksum)
				return;

			code.componentschecksum = checksum;
			SET('code.components', components);

			if (is && !common.form && code.current && !code.current.$components && common.showparts) {
				SETTER('dockable/show', 'prop');
				SET('common.form', 'components');
				code.current.$components = 0;
				clipboardresize();
			}
		};

		exports.debug = function() {
			TOGGLE('common.debug');
		};

		exports.debugclear = function() {
			if (!BLOCKED('debugclear', 3000)) {
				var thread = code.current && code.current.path ? code.current.path.match(/\/threads\/\w+/) : null;
				AJAX(('GET /api/projects/{id}/logfile/clear/' + (thread ? '?thread=' + thread.toString().substring(9) : '')).arg(code.data), NOOP);
			}
		};

		exports.localize = function() {
			SETTER('loading/show');
			AJAX('GET /api/projects/{id}/localize/'.arg(code.data), function(response) {
				SET('resourcesdiff.b', response.value);
				EXEC('code/resourcediff', 'show');
				SETTER('loading/hide', 500);
			});
		};

		exports.database = function(conn) {
			var obj = {};
			obj.id = 'db' + HASH(conn, true);

			var win = windows.findItem('id', obj.id);
			if (win) {
				SETTER('windows/show', obj.id);
				return;
			}

			obj.hidden = false;
			obj.offset = { x: ((WW / 2) - 350) >> 0, y: ((WH / 2) - 150) >> 0, width: 800, height: 500, minwidth: 600, minheight: 400 };
			obj.title = '<i class="ti ti-database"></i> @(Database viewer)';
			obj.html = '<iframe src="/dbviewer/?conn={0}&id={1}" style="width:100%;height:100%;border:0" frameborder="0"></iframe>'.format(encodeURIComponent(conn), obj.id);
			obj.actions = { minimize: true, maximize: true, move: true, resize: true, autosave: true };
			PUSH('windows', obj);
		};

		exports.resourcediff = function(show) {

			if (windows.findItem('id', 'diff')) {
				SETTER('windows/' + (show ? 'show' : 'toggle'), 'diff');
				return;
			}

			var obj = {};
			obj.id = 'diff';
			obj.hidden = false;
			obj.offset = { x: ((WW / 2) - 350) >> 0, y: ((WH / 2) - 150) >> 0, width: 700, height: 600, minwidth: 500, minheight: 300 };
			obj.title = '<i class="ti ti-code-branch"></i> @(Diff resource)';
			obj.html = '<div data-import="url:/partial/diff.html"></div>';
			obj.actions = { minimize: true, maximize: true, move: true, resize: true, autosave: true, hide: true };
			PUSH('windows', obj);
		};

		exports.chat = function(show) {

			if (windows.findItem('id', 'chat')) {
				SETTER('windows/' + (show ? 'show' : 'toggle'), 'chat');
				return;
			}

			var obj = {};
			obj.id = 'chat';
			obj.hidden = false;
			obj.offset = { x: ((WW / 2) - 350) >> 0, y: ((WH / 2) - 150) >> 0, width: 700, height: 300, minwidth: 300, minheight: 150 };
			obj.title = '<i class="ti ti-comments"></i> @(Internal chat)';
			obj.html = '<div data-import="url:/partial/chat.html"></div>';
			obj.actions = { minimize: true, maximize: true, move: true, resize: true, autosave: true, hide: true };

			if (!W.chat)
				W.chat = { current: '' };

			PUSH('windows', obj);
		};

		exports.editpath = function(el) {
			SETTER('tree/selectpath', el.attrd('path') || '');
		};

		function watchlogfilescroll() {
			SETTER(true, '#viewboxdebug/scrollbottom', 0);
			SETTER('#viewboxdebug/resizescrollbar');
		}

		function watchlogfile() {
			var thread = code.current && code.current.path ? code.current.path.match(/\/threads\/\w+/) : null;
			AJAX(('GET /api/projects/{id}/logfile/' + (thread ? '?thread=' + thread.toString().substring(9) : '')).arg(code.data), function(response) {
				common.debug && setTimeout(watchlogfile, 1500);
				if (response !== common.debugprev) {
					common.debugprev = response;
					SET('common.debughtml', Thelpers.encode(response).replace(/\n/g, '<br />'));
					setTimeout(watchlogfilescroll, 200);
				}
			});
		}

		WATCH('common.debug', function(path, value, type) {

			if (value) {

				if (windows.findItem('id', 'logs')) {
					watchlogfile();
					SETTER('windows/show', 'logs');
					SETTER('#viewboxdebug/resizescrollbar');
					return;
				}

				var obj = {};
				obj.id = 'logs';
				obj.hidden = false;
				obj.offset = { x: WW - 850, y: WH - 430, width: 800, height: 300, minwidth: 200, minheight: 200 };
				obj.title = '<i class="ti ti-spin ti-spinner green"></i>@(Logs)';
				obj.html = '<div data-import="url:/partial/logs.html"></div>';
				obj.actions = { minimize: false, maximize: false, move: true, resize: true, autosave: true, menu: true, hide: true };
				obj.make = function(el) {
					el.parent().find('.ui-windows-lastbutton').rclass2('ti-').aclass('ti-trash');
					el.closest('.ui-windows-item').css('z-index', 101);
				};
				obj.close = function(next) {
					next();
					SET('common.debug', false);
				};
				obj.menu = exports.debugclear;
				PUSH('windows', obj);
				watchlogfile();
			} else
				SETTER('windows/hide', 'logs');

		});

		WATCH('common.form', function(path, value) {
			if (value === '' && code.current)
				code.current.$components = 1;

			if (!value)
				SETTER('dockable/hide', 'prop');

			setTimeout(clipboardresize, 500);
		});

		exports.todo = function(todo) {

			if (!code.data || !code.editor.path)
				return;

			var item = code.data.todo.findItem('path', code.editor.path);
			if (item == null) {
				item = { path: code.editor.path, items: [] };
				code.data.todo.push(item);
			}

			if (todo.length)
				item.items = todo;
			else
				code.data.todo = code.data.todo.remove('path', code.editor.path);

			SET('code.data.todocurrent', todo);
			UPD('code.data.todo');
		};

		exports.codetasks_unsolved = function(value) {
			var count = 0;
			if (code.data && code.data.todo) {
				for (var i = 0; i < code.data.todo.length; i++)
					count += code.data.todo[i].items.length;
			}
			return count > 99 ? 99 : count;
		};

		exports.append = function(val) {
			editor.editor.replaceSelection(val + '\n');
		};

		exports.appendcustom = function(fn) {
			var cur = editor.editor.getCursor();
			var c = editor.editor.getRange({ line: cur.line, ch: cur.ch - 1 }, { line: cur.line, ch: cur.ch });
			fn(editor.editor, cur, c);
		};

		exports.move = function(line, ch, lineto) {
			var e = editor.editor;

			var cur = e.getCursor();
			e.setCursor({ line: line || 0, ch: ch || 0 });
			e.centerLine(line);
			e.focus();

			if (lineto && line === cur.line)
				e.setSelection(e.getCursor(), { line: lineto });
		};

		exports.syncdata = function() {

			var min;
			exports.readonly(true);

			for (var i = 0; i < code.usersfile.length; i++) {
				var usr = code.usersfile[i];

				if (usr.connid === common.id)
					continue;

				if (!min) {
					min = usr;
					continue;
				}

				if (min.ts && usr.ts && min.ts > usr.ts)
					min = usr;
			}

			if (min) {
				SET('code.multiple', false);
				SETTER('loading/show');
				FUNC.wssend({ TYPE: 'syncsend', projectid: code.projectid, connid: common.id, fromid: min.id });
				common.synctimeout = setTimeout(function() {
					// 5 seconds
					// Maybe zombie connection
					SETTER('loading/hide');
					common.synctimeout = null;
					$('#body').rclass('warning');
					FUNC.warning('@(Unable to synchronize code between users, because the main user may be offline.)');
					code.issyncing = false;
					exports.readonly(false);
				}, 5000);
			}

			exports.tablocked();
		};

		exports.syncsave = function(msg) {

			var p = 'code.saved';

			if (msg && msg.projectid === code.projectid)
				setTimeout(exports.changelog, 2000);

			if (!msg || msg instanceof jQuery || msg.connid === common.id || msg.id === user.id) {
				SET(p, null);
				return;
			}

			if (msg.projectid === code.projectid) {

				// Remove tab changes indicator
				if (code.SYNC && code.current && code.current.modified) {
					code.current.modified = false;
					exports.element.find('section.tabs').find('span[data-value="{0}"]'.format(code.current.path)).rclass('modified');
				}

				editor.diffgutterclear();

				SET(p, msg.user);
				setTimeout2(p, function() {
					SET(p, null);
				}, 5000);
			}
		};

		exports.readonly = function(value) {
			FIND('editor').editor.setOption('readOnly', value);
		};

		exports.synccursor = function(msg) {
			for (var i = 0; i < code.usersfile.length; i++) {
				var uf = code.usersfile[i];
				if (uf.connid === msg.connid) {
					editor.marker(uf.connid, msg.fline, msg.fch, msg.tline, msg.tch, uf.color, uf.id);
					return;
				}
			}
		};

		exports.reload = function() {

			EMIT('resize', exports.element);

			var id = NAV.query.id;
			id && exports.load(id);

			SET('%projectsvisible', false);

			AJAX('GET /api/projects/', function(response) {

				response.quicksort('pinned_desc,name_asc');
				SET('code.projects', response);

				var index = 0;
				var isrecent = false;

				while (true) {
					var recent = common.recent[index];
					if (!recent)
						break;
					var project = response.findItem('id', recent.id);
					if (project == null) {
						isrecent = true;
						common.recent.splice(index - 1, 1);
					} else {
						if (recent.name !== project.name) {
							isrecent = true;
							recent.name = project.name;
						}
						index++;
					}
				}

				isrecent && UPD('common.recent');

				var keys = Object.keys(localStorage);
				var projects = {};

				// Clears cache
				for (var i = 0; i < response.length; i++)
					projects[code.projects[i].id] = 1;

				for (var i = 0; i < keys.length; i++) {
					var id = keys[i].substring(0, keys[i].indexOf('_'));
					if (id && id.length > 15 && !projects[id])
						localStorage.removeItem(keys[i]);
				}
			});
		};

		exports.templates = function() {
			SET('common.form', 'templates');
		};

		exports.changes = function() {
			SET('common.form', 'changes');
		};

		exports.contextmenu = function(e, editor) {

			var items = [];
			var sel = editor.getSelections();
			var text = sel.join('');
			var can = text.length > 0;
			var sub = [];
			var tools = [];
			var tmp;
			var isscript = !code.data.isexternal && (/\/scripts\/|\.sh$/g).test(code.current.path) || (code.data.servicemode && (code.current.ext === 'js' || code.current.ext === 'sh' || code.current.ext === 'py'));
			var mode = editor.getModeAt(editor.getCursor());
			mode = mode.helperType || mode.name;

			if (code.current.ext === 'html' && text.indexOf('<scri' + 'pt type="text/json">'))
				items.push({ name: '@(Preview template)', icon: 'ti ti-search-plus', value: 'previewtemplate' });

			if (isscript && !text && !common.cloud)
				items.push({ name: '@(Run script)', icon: 'play-alt red', value: 'run', classname: 'b', shortcut: (common.ismac ? 'CMD' : 'CTRL') + '+B' });

			if (!can && (code.current.ext === 'ui' || (code.current.ext === 'json' && editor.getValue().indexOf('"components"') !== -1))) {
				items.push({ name: '@(Open UI Builder)', icon: 'totaljs', value: 'uibuilder', classname: 'b' });
				items.push('-');
			}

			if (!can && code.current.ext === 'flow') {
				items.push({ name: '@(Open FlowStream designer)', icon: 'flow', value: 'flowstream', classname: 'b' });
				items.push('-');
			}

			if (can) {

				if (code.current.ext === 'resource')
					items.push({ name: '@(Clean content)', icon: 'clean', value: 'resourceclean', classname: 'b' });

				if ((user.sa || user.dbviewer) && (/hex\s\w+|base64\s\w+|postgresql\:|postgre\:|postgres\:|psql\:|pg\:/i).test(text))
					items.push({ name: '@(Open DB viewer)', icon: 'database', value: 'dbviewer', classname: 'b' });

				if ((/api/).test(code.current.ext))
					items.push({ name: '@(Run)', icon: 'play red', value: 'run', classname: 'b', shortcut: (common.ismac ? 'CMD' : 'CTRL') + '+B' });

				items.push({ name: '@(Show selected)', icon: '!ti ti-object-group', value: 'showselected' });

				var isnewline = text.indexOf('\n') !== -1;

				if (text.length > 5) {

					var chatgpt = [];
					if (!isnewline) {
						chatgpt.push({ name: '@(Fix Spelling and Grammar)', icon: '!ti ti-spellcheck', value: 'chatgpt-grammar' });
						chatgpt.push({ name: '@(Generate text)', icon: '!ti ti-align-justify', value: 'chatgpt-generate' });
					}
					chatgpt.push({ name: '@(Make keywords)', icon: '!ti ti-font', value: 'chatgpt-keywords' });
					chatgpt.push({ name: '@(Summarize)', icon: '!ti ti-compress', value: 'chatgpt-summarize' });
					chatgpt.push('-');
					chatgpt.push({ name: '@(Ask)', icon: '!ti ti-question-circle', value: 'chatgpt-ask' });
					items.push({ name: '@(OpenAI)', icon: '!ti ti-openai', children: chatgpt });
				}

				items.push({ name: '@(Copy)', icon: '!ti ti-copy', command: 'copy' });
				items.push({ name: '@(Copy with syntax)', icon: 'print', value: 'copysyntax' });
				items.push({ name: '@(Copy as Markdown)', icon: '!ti ti-pointer', value: 'copymarkdown' });

				if (mode === 'css' || mode === 'html' || mode === 'js' || code.current.ext === 'css' || code.current.ext === 'js' || code.current.ext === 'html' || code.current.ext === 'sh')
					items.push({ name: '@(Copy as Image)', icon: 'ti ti-image', value: 'copycarbon' });

				if (text.indexOf('<') !== -1)
					items.push({ name: '@(Copy without tags)', icon: '!ti ti-copy', value: 'copytext' });

				if (can && (/^(http(s)?:)?\/\/[^\s]+/).test(text))
					items.push({ name: '@(Download to clipboard)', icon: 'cloud-download', value: 'downloadclipboard' });

				if (text.indexOf('.define(\'') !== -1) {
					items.push({ name: '@(Copy as JSON)', icon: '!ti ti-code', value: 'copyasjson' });
					items.push({ name: '@(Copy as JSON schema)', icon: '!ti ti-object-group', value: 'copyasjsonschema' });
				}

				if (text.indexOf('NEWSCHEMA(') !== -1) {
					items.push('-');
					items.push({ name: '@(Copy as <strong>API routes</strong>)', icon: 'copy', value: 'create_api' });
					items.push({ name: '@(Copy as <strong>REST routes</strong>)', icon: 'copy', value: 'create_rest' });
				}

				if (code.current.path.indexOf('.resource') !== -1)
					items.push({ name: '@(Translate)', icon: 'ti ti-language-alt', value: 'localize' });

				items.push('-');

				if (can && code.current.ext === 'js') {
					tmp = ((/varchar|int|boolean/i).test(text));
					tmp && items.push({ name: '@(Transform SQL to schema)', icon: 'database', value: 'sql2schema' });
				}

				if (can)
					tools.push({ name: '@(Parse keys)', icon: 'barcode', value: 'parsekeys' });

				if ((mode === 'css' || code.current.ext === 'css' || code.current.ext === 'html') && (/\:(\s)?#|#\w{6}|background|border|stroke|fill|color|rgba\:/).test(text))
					items.push({ name: '@(Transform to Dark mode)', icon: 'tint', value: 'darkmode' });

				if ((mode === 'css' || code.current.ext === 'css' || code.current.ext === 'html'))
					items.push({ name: '@(Transform to Responsive)', icon: 'tablet', value: 'responsive' });

				if ((/(#)?[A-F0-9]{6}/i).test(text) && text.indexOf('\n') === -1)
					items.push({ name: '@(Convert to RGBA)', icon: 'palette', value: 'hex2rgba' });

				if (((/\d+,(\s)?\d+,(\s)?\d+/i)).test(text))
					items.push({ name: '@(Convert to HEX)', icon: 'palette', value: 'rgba2hex' });

				if (mode === 'css' || (/css/).test(code.current.ext)) {
					items.push({ name: '@(Sort CSS properties)', icon: 'sort', value: 'sortcss' });
					items.push({ name: '@(Clean CSS)', icon: 'clean', value: 'cleancss' });
				}

				if ((/[:\|\='"\{]/).test(text))
					items.push({ name: '@(Align)', icon: 'align-left', value: 'align' });

				if (code.current.ext === 'js' && text.indexOf('ROUTE(') !== -1)
					items.push({ name: '@(Align routes)', icon: 'align-justify', value: 'alignrouting' });

				if ((/js|css|html/).test(code.current.ext)) {
					items.push({ name: '@(Comment)', icon: 'comment', value: 'comment' });
					if (code.current.ext !== 'css') {
						tmp = text.charAt(0);
						if (tmp === '[' || tmp === '{')
							items.push({ name: '@(Format JSON)', icon: 'clean', value: 'formatjson' });
						/*else if (code.current.ext === 'html')
							items.push({ name: '@(Beautify HTML)', icon: 'clean', value: 'formathtml' });*/
					}
				}

				if (text.indexOf('\n') !== -1)
					items.push({ name: '@(Sort)', icon: 'sort', value: 'sort' });

				sub = [];
				sub.push({ name: '@(Base64)', icon: 'chevron-right', value: 'btoa' });
				sub.push({ name: '@(Hex)', icon: 'chevron-right', value: 'hexe', server: true });
				sub.push({ name: '@(Encode URI)', icon: 'chevron-right', value: 'encodeURIComponent' });
				sub.push({ name: '@(Escape)', icon: 'chevron-right', value: 'escape' });
				sub.push({ name: '@(Slug)', icon: 'chevron-right', value: 'slug' });
				sub.push({ name: '@(HASH)', icon: 'chevron-right', value: 'HASH' });
				sub.push({ name: '@(Localize)', icon: 'chevron-right', value: 'translate' });
				sub.push({ name: '@(MD5)', icon: 'chevron-right', value: 'md5', server: true });
				sub.push({ name: '@(SHA-1)', icon: 'chevron-right', value: 'sha1', server: true });
				sub.push({ name: '@(SHA-256)', icon: 'chevron-right', value: 'sha256', server: true });
				sub.push({ name: '@(SHA-512)', icon: 'chevron-right', value: 'sha512', server: true });
				sub.push({ name: '@(CRC-32)', icon: 'chevron-right', value: 'crc32', server: true });
				sub.push({ name: '@(CRC-32 unsigned)', icon: 'chevron-right', value: 'crc32unsigned', server: true });
				sub.push({ name: '@(JSON escape)', icon: 'chevron-right', value: 'jsonescape' });
				sub.push({ name: '@(Optimize for search)', icon: 'search', value: 'search' });
				items.push({ name: '@(Encode)', icon: 'lock', value: 'encode', children: sub });

				sub = [];
				sub.push({ name: '@(Hex)', icon: 'chevron-right', value: 'hexd', server: true });
				sub.push({ name: '@(Base64)', icon: 'chevron-right', value: 'atob' });
				sub.push({ name: '@(Decode URI)', icon: 'chevron-right', value: 'decodeURIComponent' });
				sub.push({ name: '@(Unescape)', icon: 'chevron-right', value: 'unescape' });
				sub.push({ name: '@(JSON unescape)', icon: 'chevron-right', value: 'jsonunescape' });
				items.push({ name: '@(Decode)', icon: 'unlock', value: 'decode', children: sub });

				sub = [];
				sub.push({ name: '@(JavaScript)', icon: 'chevron-right', value: 'js' });
				sub.push({ name: '@(HTML)', icon: 'chevron-right', value: 'html' });
				sub.push({ name: '@(CSS)', icon: 'chevron-right', value: 'css' });
				sub.push({ name: '@(JSON)', icon: 'chevron-right', value: 'json' });
				items.push({ name: '@(Minify code)', icon: 'compress', value: 'minify', children: sub });

				items.push({ name: '@(Tools)', icon: 'wrench', children: tools });
				tools.push({ name: '@(Upper Case)', icon: 'font', value: 'upper' });
				tools.push({ name: '@(Lower Case)', icon: 'font', value: 'lower' });
				tools.push({ name: '@(Clean duplicated lines)', icon: 'clean', value: 'cleanduplicatedlines' });

				if (code.current.ext === 'css')
					tools.push({ name: '@(Remove dark mode)', icon: 'adjust', value: 'removedarkmode' });

				if (sel.length === 1 && (/^[\.\w\/\:\-]*$/i).test(text)) {
					tools.push('-');
					tools.push({ name: '@(Resolve IP address)', icon: 'ethernet', value: 'resolve' });
					tools.push({ name: '@(Ping domain)', icon: 'sitemap', value: 'ping' });
				}

				items.push('-');
			}

			sub = [];

			if ((/^(js|css|html)$/).test(code.current.ext))
				sub.push({ name: '@(UI components)', icon: 'chevron-right', value: 'ui' });

			sub.push({ name: 'UID', icon: 'chevron-right', value: 'uid' });
			sub.push({ name: '@(UID random)', icon: 'chevron-right', value: 'uidr' });
			sub.push({ name: 'UID16', icon: 'chevron-right', value: 'uid16' });
			sub.push({ name: 'GUID', icon: 'chevron-right', value: 'guid' });
			sub.push({ name: '@(Token)', icon: 'chevron-right', value: 'token' });
			sub.push({ name: '@(Password)', icon: 'chevron-right', value: 'password' });
			sub.push({ name: '@(URL / Hostname)', icon: 'chevron-right', value: 'url' });
			sub.push({ name: '@(IP address - my)', icon: 'chevron-right', value: 'ip' });
			sub.push({ name: '@(IP address - server)', icon: 'chevron-right', value: 'ipserver' });
			sub.push({ name: '@(Date / Time)', icon: 'chevron-right', value: 'date' });

			sub.push('-');
			sub.push({ name: '<>="\'`', icon: 'keyboard', id: 'char' });
			sub.push({ name: '()[]{}', icon: 'keyboard', id: 'char' });
			sub.push({ name: ':+-*\\/|', icon: 'keyboard', id: 'char' });
			sub.push({ name: '_&*~$', icon: 'keyboard', id: 'char' });
			sub.push({ name: '%!@#°^', icon: 'keyboard', id: 'char' });

			items.push({ name: '@(Insert)', icon: 'plus-circle green', value: 'insert', children: sub });
			items.push({ name: '@(Insert emoji)', icon: 'smile yellow', value: 'emoji' });
			items.push({ name: '@(Insert color)', icon: 'fill colorize', value: 'colorpicker' });
			items.push({ name: '@(Insert icon)', icon: 'image blue', value: 'icon' });

			if (code.current.path.indexOf('/config') !== -1)
				items.push({ name: '@(Insert connection string)', icon: 'database', value: 'insertconnection' });

			items.push({ name: '@(Toggle ruler)', icon: 'arrows-v', value: 'toggleruler' });

			if ((/js|json|html|todo|api|txt|versions|sitemap/).test(code.current.ext) || code.current.name === 'Dockerfile') {

				sub = [];

				if (code.current.name === 'Dockerfile') {
					sub.push({ name: '@(Dockerfile)', icon: 'docker', value: 'template', id: 'dockerfile' });
				} else if (code.current.path.substring(0, 9) === '/scripts/' && code.current.ext === 'js') {
					sub.push({ name: '@(Script)', icon: 'code', value: 'template', id: 'script' });
				} else if (code.current.ext === 'js') {
					sub.push({ name: '@(Controller)', icon: 'code', value: 'template', id: 'controller' });
					sub.push({ name: '@(Start script v5)', icon: 'code', value: 'template', id: 'index5' });
					sub.push({ name: '@(Start script v4)', icon: 'code', value: 'template', id: 'index' });
					sub.push({ name: '@(Test script)', icon: 'code', value: 'template', id: 'test' });
					sub.push({ name: '@(Upload + FileStorage)', icon: 'code', value: 'template', id: 'upload' });
				} else if (code.current.ext === 'json') {
					sub.push({ name: '@(openplatform.json)', icon: 'code', value: 'template', id: 'openplatform' });
					sub.push({ name: '@(package.json)', icon: 'code', value: 'template', id: 'package' });
				} else if (code.current.ext === 'todo') {
					sub.push({ name: '@(TO-DO example)', icon: 'code', value: 'template', id: 'todo' });
				} else if (code.current.ext === 'api') {
					sub.push({ name: '@(API example)', icon: 'code', value: 'template', id: 'restapi' });
				} else if (code.current.ext === 'txt') {
					sub.push({ name: '@(MIT license)', icon: 'code', value: 'template', id: 'license' });
				} else if (code.current.ext === '/versions') {
					sub.push({ name: '@(Versions template)', icon: 'code', value: 'template', id: 'versions' });
				} else if (code.current.ext === '/sitemap') {
					sub.push({ name: '@(Sitemap template)', icon: 'code', value: 'template', id: 'sitemap' });
				} else {
					sub.push({ name: '@(HTML template)', icon: 'code', value: 'template', id: 'html' });
					sub.push({ name: '@(Mail template)', icon: 'code', value: 'template', id: 'email' });
					sub.push({ name: '@(OpenTemplate)', icon: 'code', value: 'template', id: 'template' });
					sub.push({ name: '@(Plugin)', icon: 'code', value: 'template', id: 'plugin' });
					sub.push({ name: '@(j-Box)', icon: 'code', value: 'template', id: 'box' });
					sub.push({ name: '@(j-MiniForm)', icon: 'code', value: 'template', id: 'miniform' });
					sub.push({ name: '@(j-LargeForm)', icon: 'code', value: 'template', id: 'largeform' });
					sub.push({ name: '@(j-Form)', icon: 'code', value: 'template', id: 'form' });
					sub.push({ name: '@(j-Intro)', icon: 'code', value: 'template', id: 'intro' });
					sub.push({ name: '@(j-Modal)', icon: 'code', value: 'template', id: 'modal' });
					sub.push({ name: '@(j-Panel)', icon: 'code', value: 'template', id: 'panel' });
					sub.push({ name: '@(j-Window)', icon: 'code', value: 'template', id: 'window' });
					sub.push({ name: '@(j-Centered)', icon: 'code', value: 'template', id: 'centered' });
				}

				items.push({ name: '@(Insert template)', icon: 'plus-circle green', value: 'template', children: sub });
			}

			SETTER('menu/showxy', e.pageX + 5, e.pageY - 15, items, function(value) {

				if (value.command) {
					editor.focus();
					setTimeout(function() {
						document.execCommand(value.command, true);
					}, 100);
					return;
				}

				if (value.value === 'previewtemplate') {
					rendertemplate(editor.getValue());
					return;
				}

				if (value.value === 'uibuilder') {
					var data = {};
					data.data = PARSE(editor.getValue()) || {};
					data.publish = function(response) {
						SETTER('clipboard/copy', JSON.stringify(response));
						SETTER('notifybar/success', '@(The build has been copied into the clipboard successfully)');
					};
					data.save = function(response) {
						editor.setValue(JSON.stringify(response, null, '\t'));
						setTimeout(() => exports.save(), 500);
					};
					SETTER('uidesigner/load', data);
					return;
				}

				if (value.value === 'flowstream') {
					SETTER('flowstream/load', editor.getValue(), function() {
						editor.setValue(JSON.stringify(response, null, '\t'));
						setTimeout(() => exports.save(), 500);
					});
					return;
				}

				if (value.value === 'showselected') {
					EXEC('code/showselected');
					return;
				}

				if (value.value.substring(0, 8) === 'chatgpt-') {

					var tmp = '\n\n' + text.trim();
					switch (value.value.substring(8)) {
						case 'grammar':
							tmp = '@(Correct this to standard English:)' + tmp;
							break;
						case 'keywords':
							tmp = '@(Extract keywords from this text:)' + tmp;
							break;
						case 'summarize':
							tmp = '@(Summarize this text:)' + tmp;
							break;
						case 'generate':
							tmp = '@(Create text about:)' + tmp;
							break;
						case 'ask':
							tmp = tmp.trim();
							break;
					}

					AJAX('POST /api/chatgpt/ @showloading ERROR', { value: tmp }, function(response) {
						editor.replaceSelection(response.text.trim());
						SETTER('loading/hide');
					});
					return;
				}

				if (value.value === 'resourceclean') {
					editor.replaceSelection(FUNC.resources_clean(text.trim()));
					return;
				}

				if (value.value === 'localize') {

					var arg = W.formlocalize || {};

					arg.callback = function(url) {

						var lines = text.split('\n');
						var output = [];
						var translate = [];

						for (var i = 0; i < lines.length; i++) {
							var m = lines[i];
							var index = m.indexOf(':');
							var obj = { line: i, from: index + 1, source: m.substring(0, index), text: m.substring(index + 1).trim() };
							output.push(obj);
							translate.push('- ' + obj.text);
						}

						AJAX(url + encodeURIComponent(translate.join('\n')), function(response) {
							var builder = [];
							for (var i = 0; i < response[0].length; i++) {
								var arr = response[0][i];
								var m = output[i];
								if (m && m.source && arr[0])
									builder.push(m.source + ': ' + (arr[0] || '').trim().substring(2));
								else
									builder.push('');
							}
							editor.replaceSelection(builder.join('\n'));
						});
					};

					SET('formlocalize', arg);
					SET('common.form', 'formlocalize');
					return;
				}

				if (value.value === 'dbviewer') {
					EXEC('code/database', text.trim());
					return;
				}

				if (value.value === 'downloadclipboard') {
					text = text.trim();
					if (text.substring(0, 1).toLowerCase() !== 'h')
						text = 'https:' + text;
					AJAX('GET /api/common/download/?url=' + encodeURIComponent(text), ASETTER('message/response', function(response) {
						SETTER('notifybar/success', '@(The response has been copied into the clipboard successfully)');
						SETTER('clipboard/copy', response.value);
					}));
					return;
				}

				if (value.value === 'insertconnection') {
					editor.replaceSelection('postgresql://user:password@localhost:5432/database');
					return;
				}

				if (value.value === 'create_api' || value.value === 'create_rest') {
					SETTER('clipboard/copy', FUNC.createroutes(value.value === 'create_api', text));
					return;
				}

				if (value.value === 'toggleruler') {
					EDITOR.toggleruler();
					return;
				}

				if (value.value === 'resolve' || value.value === 'ping') {
					text = text.replace(/http(s)?:\/\//g, '');
					tmp = text.indexOf('/');
					if (tmp !== -1)
						text = text.substring(0, tmp);
					SETTER('loading/show');
					AJAX('POST /api/common/' + value.value, { host: text }, function(response) {
						SETTER('loading/hide');
						if (value.value === 'ping') {
							var template = '<div class="output-response-header">{0}:</div><div class="output-response-header-value">{1}</div>';
							PUSH('^output', '<div class="output-response"><div class="output-response-caption">PING: {0}</div>{1}</div>'.format(Thelpers.encode(text), template.format('Response', Thelpers.encode(response.value).replace(/\n/g, '<br />'))));
							SET('common.form', 'output');
						} else
							editor.replaceSelection(sel[0].replace(text, response.value));
					});
					return;
				}

				if (value.id === 'char') {
					editor.replaceSelection(value.name);
					return;
				}

				if (value.value === 'hex2rgba') {
					editor.replaceSelection(FUNC.hex2rgba(text));
					return;
				}

				if (value.value === 'rgba2hex') {
					editor.replaceSelection(FUNC.rgba2hex(text));
					return;
				}

				if (value.value === 'darkmode') {
					editor.replaceSelection(FUNC.colorize(text, '.ui-dark'));
					return;
				}

				if (value.value === 'responsive') {
					editor.replaceSelection(FUNC.responsive(text));
					return;
				}

				if (value.value === 'removedarkmode') {
					editor.replaceSelection(FUNC.removecssclass('.ui-dark', text));
					return;
				}

				if (value.value === 'cleanduplicatedlines') {
					editor.replaceSelection(FUNC.cleanduplicatedlines(text));
					return;
				}

				if (value.value === 'copycarbon') {
					var cur = editor.getModeAt(editor.getCursor());
					var t = cur.helperType || cur.name;

					if (t === 'html')
						t = 'htmlmixed';

					W.open('https://carbon.now.sh/?l={0}&code={1}'.format(t, encodeURIComponent(FUNC.strim(text).replace(/\t/g, '    '))));
					return;
				}

				if (value.value === 'copyasjson') {
					SETTER('clipboard/copy', FUNC.makejsonfromschema(text));
					return;
				}

				if (value.value === 'copyasjsonschema') {
					SETTER('clipboard/copy', FUNC.makejsonschemafromschema(text));
					return;
				}

				if (value.value === 'copytext') {
					SETTER('clipboard/copy', text.removeTags());
					return;
				}

				if (value.value === 'copysyntax') {
					var div = document.createElement('DIV');
					var el = document.createElement('PRE');
					div.style = 'position:absolute;left:-2000px;top:-2000px;opacity:0';
					div.appendChild(el);
					document.body.appendChild(div);
					var cur = editor.getModeAt(editor.getCursor());
					var t = cur.helperType || cur.name;
					if (t === 'json')
						t = 'application/ld+json';
					CodeMirror.runMode(FUNC.strim(text).replace(/\t/g, '  '), t, el);
					el.setAttribute('class', 'cm-s-default');
					el.setAttribute('contenteditable', 'true');
					el.focus();
					document.execCommand('selectAll', false, null);
					document.execCommand('copy', false, null);
					setTimeout(function() {
						document.body.removeChild(div);
					}, 500);
					return;
				}

				if (value.value === 'copymarkdown') {
					var cur = editor.getModeAt(editor.getCursor());
					var syntax = FUNC.getext(cur.helperType || cur.name);
					SETTER('clipboard/copy', '```' + syntax + '\n' + FUNC.strim(text).replace(/\t/g, '  ').trim() + '\n```');
					return;
				}

				if (value.value === 'formatjson') {
					try {
						editor.replaceSelection(JSON.stringify(JSON.parse(text), null, '\t'));
					} catch (e) {}
					return;
				}

				if (value.value === 'formathtml') {
					editor.replaceSelection(FUNC.formathtml(text));
					return;
				}

				if (value.value === 'run') {
					if (isscript)
						FUNC.requestscriptspawn(code.data.id, code.current.path);
					else
						FUNC.request(text, editor.getValue());
					return;
				}

				if (value.value === 'alignrouting') {
					editor.replaceSelection(FUNC.alignrouting(text));
					return;
				}

				if (value.value === 'sql2schema') {
					editor.replaceSelection(FUNC.sql2schema(text));
					return;
				}

				if (value.value === 'parsekeys') {
					tmp = FUNC.parsekeys(text);
					editor.replaceSelection(tmp.join(','));
					return;
				}

				if (value.value === 'url') {
					editor.replaceSelection(code.data.url);
					return;
				}

				if (value.value === 'cleancss' || value.value === 'sortcss') {
					editor.replaceSelection(FUNC[value.value](text));
					return;
				}

				if (value.value === 'icon') {
					exports.addicon();
					return;
				}

				if (value.value === 'emoji') {
					var opt = {};
					opt.x = e.pageX - 10;
					opt.y = e.pageY - 20;
					opt.callback = function(selected) {
						editor.replaceSelection(selected);
					};
					setTimeout(function() {
						SETTER('emoji/show', opt);
					}, 100);
					return;
				}

				if (value.value === 'colorpicker') {
					var opt = {};
					opt.x = e.pageX - 10;
					opt.y = e.pageY + 10;
					opt.callback = function(selected) {
						editor.replaceSelection(selected);
					};
					setTimeout(function() {
						SETTER('colorpicker/show', opt);
					}, 100);
					return;
				}

				setTimeout(function() {

					var items = [];
					var y = 0;
					var x = 20;

					if (value.value === 'sort') {

						for (var i = 0; i < sel.length; i++) {
							sel[i] = sel[i].split('\n');
							sel[i].sort();
							sel[i] = sel[i].join('\n');
						}

						editor.replaceSelections(sel);
						return;
					}

					if (value.value === 'upper' || value.value === 'lower') {
						for (var i = 0; i < sel.length; i++)
							sel[i] = value.value === 'lower' ? sel[i].toLowerCase() : sel[i].toUpperCase();
						editor.replaceSelections(sel);
						return;
					}

					if (value.value === 'comment') {

						var cur = editor.getModeAt(editor.getCursor());
						var syntax = FUNC.getext(cur.helperType || cur.name);

						for (var i = 0; i < sel.length; i++) {
							sel[i] = sel[i].split('\n');
							sel[i] = FUNC.comment(syntax, sel[i]).join('\n');
						}

						editor.replaceSelections(sel);
						return;
					}

					if (value.value === 'align') {
						if (code.current.name === 'sitemap') {
							for (var i = 0; i < sel.length; i++) {
								sel[i] = sel[i].split('\n');
								sel[i] = FUNC.alignsitemap(sel[i]).join('\n');
							}
							editor.replaceSelections(sel);
						} else {
							for (var i = 0; i < sel.length; i++) {
								sel[i] = sel[i].split('\n');
								sel[i] = FUNC.aligntext(sel[i]).join('\n');
							}
							editor.replaceSelections(sel);
						}
						return;
					}

					if (value.server) {
						var model = {};
						model.type = value.value;
						model.body = sel;
						AJAX('POST /api/common/encrypt/', model, function(response) {
							editor.replaceSelections(response);
						});
						return;
					}

					switch (value.value) {
						case 'search':
							for (var i = 0; i < sel.length; i++)
								sel[i] = sel[i].toSearch();
							editor.replaceSelections(sel);
							break;
						case 'template':
							AJAX('GET /api/templates/' + value.id, function(response) {
								var url = code.data.url;
								if (url.substring(url.length - 1) === '/')
									url = url.substring(url.length - 1);
								editor.replaceSelection(response.replace(/@URL/g, url));
							});
							break;
						case 'ui':
							SET('common.form', 'componentator');
							break;
						case 'snippet':
							SET('common.form', 'snippets');
							break;
						case 'uid':
						case 'uidr':
						case 'uid16':
						case 'ip':
						case 'ipserver':
							AJAX('GET /api/common/{0}/?projectid={1}'.format(value.value, code.data.id), function(response) {
								editor.replaceSelection(response);
							});
							break;
						case 'date':
							var dt = new Date();
							dt.setSeconds(0);
							dt.setMilliseconds(0);
							editor.replaceSelection(dt.format('iso'));
							break;
						case 'password':
							var pwd = GUID(15);
							for (var i = 0; i < pwd.length; i++) {
								if (i % 2 === 0)
									pwd = pwd.substring(0, i) + pwd.substring(i, i + 1).toUpperCase() + pwd.substring(i + 1);
							}
							editor.replaceSelection(pwd);
							break;
						case 'token':
							var pwd = GUID(35);
							var tmp = (Math.random() * 3 >> 0) + 2;
							for (var i = 0; i < pwd.length; i++) {
								if (i && i % tmp === 0)
									pwd = pwd.substring(0, i) + pwd.substring(i, i + 1).toUpperCase() + pwd.substring(i + 1);
							}
							editor.replaceSelection(pwd);
							break;
						case 'GUID':
							editor.replaceSelection(GUID(50));
							break;
						case 'guid':
							editor.replaceSelection(FUNC.guid());
							break;
						case 'encodeURIComponent':
						case 'decodeURIComponent':
						case 'atob':
						case 'btoa':
						case 'escape':
						case 'unescape':
						case 'HASH':
							for (var i = 0; i < sel.length; i++) {
								try {
									sel[i] = window[value.value](sel[i]).toString();
								} catch(e) {}
							}
							editor.replaceSelections(sel);
							break;
						case 'jsonescape':
							for (var i = 0; i < sel.length; i++) {
								try {
									sel[i] = JSON.stringify(sel[i]);
								} catch(e) {}
							}
							editor.replaceSelections(sel);
							break;
						case 'jsonunescape':
							for (var i = 0; i < sel.length; i++) {
								try {
									sel[i] = JSON.parse(sel[i].trim());
								} catch(e) {}
							}
							editor.replaceSelections(sel);
							break;
						case 'translate':
							for (var i = 0; i < sel.length; i++)
								sel[i] = 'T' + HASH(sel[i]).toString(36);
							editor.replaceSelections(sel);
							break;
						case 'slug':
							for (var i = 0; i < sel.length; i++)
								sel[i] = sel[i][value.value]();
							editor.replaceSelections(sel);
							break;
						case 'json':
							var tmp = PARSE(editor.getSelection().trim());
							editor.replaceSelection(JSON.stringify(tmp));
							break;
						case 'js':
						case 'css':
						case 'html':
							AJAX('POST /api/files/minify/', { body: editor.getSelection(), type: value.value }, function(response) {
								editor.replaceSelection(response);
							});
							break;
					}
				}, 200);
			});
		};

		WATCH('code.editor.body', function(path, value, type) {

			// cache
			if (type === 1 && code.editor.body && code.current) {
				setTimeout2('code.modified', function() {
					if (!code.current)
						return;

					var diffel = editor.ismodified();
					var is = 0;
					if (diffel) {
						exports.cache_set();
						if (!code.current.modified) {
							code.current.modified = true;
							is = 1;
						}
					} else if (code.current.modified) {
						code.current.modified = false;
						is = 2;
					}

					is && exports.element.find('section.tabs').find('span[data-value="{0}"]'.format(code.current.path)).tclass('modified', is === 1);
					exports.tablocked();
				}, 250);
			}

			if (code.current && (!code.current.path || code.current.path.substring(code.current.path.length - 3) === '.js')) {
				setTimeout2('jshint', function() {
					SET('code.errors', JSHINT.errors.slice(0));
				}, 800);
			}
		});

		exports.warning = function(el) {
			var parent = el.closest('.alert');
			switch (parent.attrd('name')) {
				case 'backup':
					if (el.attrd('name') === 'restore') {
						editor.restore(exports.cache_get(code.editor.path));
						exports.restoreposition();
					} else
						exports.cache_rem(code.editor.path);
					SET('code.backup', false);
					break;
				case 'multiple':
					code.SYNC = false;
					if (code.backup) {
						exports.cache_rem(code.editor.path);
						SET('code.backup', false);
					}
					SET('code.multiple', false);
					break;
			}
			exports.tablocked();
		};

		var cache_sync = { TYPE: 'sync' };

		exports.sync = function(data) {
			code.SYNCUSER = user.id;
			code.SYNCID = common.id;
			// Determines how many people is editing this file?
			if (code.usersfile.length > 1 && code.SYNC) {
				cache_sync.data = STRINGIFY(data);
				cache_sync.connid = common.id;
				cache_sync.projectid = code.projectid;
				cache_sync.userid = user.id;
				FUNC.wssend(cache_sync);
			}
		};

		exports.rename = function(item, val, callback) {

			var data = {};

			data.oldpath = item.path;
			data.newpath = val;

			if (data.newpath === data.oldpath) {
				callback(false);
				return;
			}

			var c = val.charAt(0);
			var refresh = c === '/' || (c === '.' && val.indexOf('/') !== -1);

			SETTER('loading/show');
			AJAX('POST /api/files/{id}/rename/'.arg(code.data), data, function(response) {
				SETTER('loading/hide', 500);
				exports.closetab(data.oldpath);
				var el = $('.ui-tree').find('.item[data-index="{0}"]'.format(item.$pointer));
				el.find('.icon').rclass2('fa').aclass(Thelpers.fileicon(val));
				el.attr('title', val);
				common.electron && code.data.repository && exports.local(function(dir) {
					var Path = require('path');
					dir && require('fs').rename(Path.join(dir, code.data.repository, data.oldpath), Path.join(dir, code.data.repository, data.newpath), NOOP);
				});
				refresh && exports.refresh();
				setTimeout(callback, 300, response.success);
			});
		};

		exports.shortcut = function(type) {
			switch (type) {
				case 'nexttab':
					var index = code.current ? code.open.indexOf(code.current) : -1;
					if (index !== -1) {
						var next = code.open[index + 1];
						if (next == null && index !== 0)
							next = code.open[0];
						next && exports.opentab(next.path);
					}
					break;
				case 'F5':
					FUNC.editor_reload();
					break;
				case 'save':
					exports.save();
					break;
				case 'close':
					setTimeout2('closetab', exports.close, 200);
					break;
				case 'swaplineup':
				case 'swaplinedown':

					var sel = EDITOR.editor.listSelections()[0];
					var plus = type === 'swaplineup' ? -1 : 1;

					var cfrom = EDITOR.editor.getCursor(true);
					var cto = EDITOR.editor.getCursor(false);

					if (cto.sticky === 'after')
						cto.line--;

					var linefrom = cfrom.line;
					var lineto = cto.line;

					EDITOR.editor.setSelection({ ch: 0, line: linefrom }, { line: lineto });

					if (plus === -1 && (linefrom - 1) < 0)
						return;

					if (plus === 1 && (lineto + 1) >= EDITOR.editor.lineCount())
						return;

					var selection = EDITOR.editor.getSelection();
					if (!selection)
						selection = EDITOR.editor.getLine(linefrom);

					if (plus === 1) {
						EDITOR.editor.replaceRange(EDITOR.editor.getLine(lineto + plus), { ch: 0, line: linefrom }, { line: lineto });
						EDITOR.editor.replaceRange(selection, { ch: 0, line: linefrom + plus }, { line: linefrom + plus });
					} else {
						EDITOR.editor.replaceRange(EDITOR.editor.getLine(linefrom + plus), { ch: 0, line: linefrom }, { line: lineto });
						EDITOR.editor.replaceRange(selection, { ch: 0, line: linefrom + plus }, { line: linefrom + plus });
					}

					EDITOR.editor.setSelection({ ch: 0, line: linefrom + plus }, { line: lineto + plus });
					break;
			}
		};

		var traverseupload = function(path, entry, callback) {

			var directory = entry.createReader();
			var files = [];
			var dirs = [];

			directory.readEntries(function(entries) {

				for (var i = 0; i < entries.length; i++) {
					var item = entries[i];
					if (item.isDirectory)
						dirs.push(item);
					else
						files.push(item);
				}

				var data = new FormData();
				var is = false;

				data.append('path', path);

				files.wait(function(item, next, index) {
					item.file(function(file) {
						is = true;
						data.append('file' + index, file);
						next();
					});
				}, function() {

					if (is) {
						UPLOAD('POST /api/projects/{id}/upload/'.arg(code.data), data, function(response) {

							if (ERROR(response)) {
								callback && callback();
								return;
							}
							dirs.wait(function(entry, next) {
								traverseupload(path + entry.name + '/', entry, next);
							}, callback);
						});
					} else {
						dirs.wait(function(entry, next) {
							traverseupload(path + entry.name + '/', entry, next);
						}, callback);
					}
				});
			});

		};

		exports.upload = function(node, e, dragfiles) {

			var path = node ? FUNC.getPath(node.path) : '/';
			var items;

			SETTER('loading/show');

			if (!dragfiles && 'WebkitAppearance' in document.documentElement.style) {

				var arr = [];
				var files2upload = false;

				items = e.dataTransfer.items;
				dragfiles = e.dataTransfer.files;

				for (let m of items) {
					let item = m.webkitGetAsEntry();
					arr.push(item);
				}

				var files = [];
				var done = function() {
					exports.load(code.data.id, true);
					SETTER('loading/hide');
					files2upload && exports.upload(node, e, dragfiles);
				};

				arr.wait(function(entry, next) {

					if (entry == null) {
						files2upload = true;
						next();
						return;
					}

					if (entry.isDirectory)
						traverseupload(path + entry.name + '/', entry, next);
					else {
						files.push(entry);
						next();
					}

				}, function() {

					var data = new FormData();
					var is = false;

					data.append('path', path);

					files.wait(function(item, next, index) {
						item.file(function(file) {
							is = true;
							data.append('file' + index, file);
							next();
						});
					}, function() {
						if (is) {
							UPLOAD('POST /api/projects/{id}/upload/'.arg(code.data), data, function(response) {
								ERROR(response);
								done();
							});
						} else
							done();
					});
				});
				return;
			}

			var data = new FormData();
			var name = [];

			items = dragfiles || e.dataTransfer.files;

			data.append('path', path);

			for (var i = 0; i < items.length; i++) {
				if (items[i].size) {
					name.push(items[i].name);
					data.append('file' + i, items[i]);
				}
			}

			if (!name.length) {
				SETTER('loading/hide');
				return;
			}

			UPLOAD('POST /api/projects/{id}/upload/'.arg(code.data), data, function(response) {
				if (!ERROR(response)) {
					FUNC.success('Uploaded successfully: <b>' + name.join(', ') + '</b>');
					exports.load(code.data.id, true);
				}
				SETTER('loading/hide');
			});
		};

		var finishhim = function() {
			if (code.current && code.current.modified)
				FUNC.totalcombat('finishhim');
		};

		exports.finishhim = function() {
			setTimeout2('finishhim', finishhim, 10000);
		};

		exports.changedcode = function(changescount) {
			if (code && code.current && code.current.path) {
				code.current.modified = changescount == null ? true : changescount > 0;
				exports.element.find('section.tabs').find('span[data-value="{0}"]'.format(code.current.path)).tclass('modified', code.current.modified);
				SET('code.current.changes', editor.difflines());
				if (code.current.modified)
					exports.finishhim();
			}
		};

		exports.open = function(item, edit) {

			if (!item || item.children)
				return;

			if (edit !== true && (/\.(build|flow|ui)$/).test(item.path)) {
				// Open designer
				AJAX('GET /api/projects/{id}/edit/'.arg(code.data), { path: item.path }, function(response) {

					SETTER('loading/show');
					SETTER('loading/hide', 2000);

					var save = function(body) {
						SETTER('loading/show');

						var data = {};
						data.body = typeof(body) === 'object' ? STRINGIFY(body) : body;
						data.path = item.path;
						data.parts = [];

						AJAX('POST /api/files/{id}/ REPEAT'.arg(code.data), data, ASETTER('message/response', function(response) {
							SETTER('loading/hide', 500);
							FUNC.wssend({ TYPE: 'save', connid: common.id, projectid: code.projectid, id: user.id, user: user.name });
							FUNC.success((response.value === 'synchronized' ? '@(<b>{0}</b> saved and synchronized.)' : '@(<b>{0}</b> saved successfully.)').format(data.path));
							common.electron && code.data.repository && user.localsave && exports.savelocal(true, item.path, data.body);
							FUNC.livereload(data.path);
						}));
					};

					var ext = item.path.substring(item.path.lastIndexOf('.') + 1);
					var type = 'builder';

					if (ext === 'ui') {
						var uidesigner = {};
						uidesigner.data = PARSE(response) || {};
						uidesigner.publish = function(response) {
							SETTER('clipboard/copy', JSON.stringify(response));
							SETTER('notifybar/success', '@(The build has been copied into the clipboard successfully)');
						};
						uidesigner.save = response => save(JSON.stringify(response, null, '\t'));
						SETTER('uidesigner/load', uidesigner);
						return;
					} else if (ext === 'flow') {
						type = 'flowstream';
					}

					SETTER(type + '/load', response, save);
				});
				return;
			}

			code.SYNCUSER = null;
			code.SYNCID = null;

			var tab = code.open.findItem('path', item.path);
			if (tab && tab.loaded) {
				code.SYNC = false;
				SET('code.multiple', false);
				if (tab.path !== code.editor.path) {
					// check if the content has been modified
					exports.edit(tab);
					exports.savetabs();
				}
				exports.tablocked();
				tab.skip = true;
				exports.element.SETTER('tree/selectpath', tab.path, true);
				tab.time = code.lastchange = Date.now();
				return;
			}

			var rewrite = false;
			var index = -1;

			// we can open file on the current tab
			if (!code.SYNC && code.current && !code.current.modified && !code.current.skip && (!tab || code.current.path !== tab.path)) {
				index = code.open.indexOf(code.current);
			} else {
				var tmp = code.open[code.open.length - 1];
				if (tmp && !tmp.skip)
					index = code.open.length - 1;
			}

			if (index !== -1 && (!code.current || !tab || code.current.path !== tab.path)) {
				code.open.splice(index, 1);
				exports.cache_rem(code.current);
				code.current = null;
			}

			var newbie = false;
			var ext = item.path.substring(item.path.lastIndexOf('.') + 1).toLowerCase();

			switch (ext) {
				case 'pdf':
				case 'jpg':
				case 'ico':
				case 'webp':
				case 'jpeg':
				case 'png':
				case 'gif':
					SETTER('imageviewer/show', item.path, '/api/download/{0}/?path={1}&preview=1'.format(code.data.id, encodeURIComponent(item.path)));
					return;
				case 'file':
				case 'nosql-binary':
					W.open('/api/download/{0}/?path={1}&preview=1'.format(code.data.id, encodeURIComponent(item.path)));
					return;
				case 'xls':
				case 'xlsx':
				case 'docx':
				case 'doc':
				case 'zip':
				case 'rar':
					W.open('/api/download/{0}/?path={1}'.format(code.data.id, encodeURIComponent(item.path)));
					return;
			}

			code.SYNC = false;
			SET('code.multiple', false);

			if (!item.iswatcher)
				SETTER('loading/show');

			AJAX('GET /api/projects/{id}/edit/'.arg(code.data), { path: item.path }, function(response) {

				SETTER('loading/hide', 500);

				if (response instanceof Array) {
					FUNC.warning(response);
					response = '';
					return;
				}

				if (!tab) {
					newbie = true;
					tab = {};
					tab.path = item.path;
					tab.name = FUNC.maketabname(item.path);
				}

				tab.loaded = true;
				tab.body = response;
				tab.ext = ext;
				tab.hashsum = HASH(response);
				tab.time = code.lastchange = Date.now();

				var cache = exports.cache_get(item.path);
				SET('code.backup', cache && cache !== response);
				newbie && PUSH('code.open', tab);
				exports.edit(tab, true);
				exports.savetabs();
				exports.element.SETTER('tree/select2', FUNC.treeindex(code.tree, item.path), true);
				editor.editor.focus();
				if (!code.ready) {
					code.ready = true;
					setTimeout(() => FUNC.totalcombat('round1'), 2000);
				}
			});
		};

		exports.opentab = function(path) {
			exports.open({ children: null, path: path }, true);
		};

		exports.addicon = function() {
			var opt = {};
			opt.align = 'center';
			opt.position = 'top';
			opt.element = $('.CodeMirror-cursor');
			opt.callback = function(icon) {
				EXEC('code/appendcustom', function(editor, cur, selected) {

					var selection = editor.getSelection();
					var text = selection ? selection : editor.lineInfo(cur.line).text;
					var prev = text.substring(cur.ch - 1, cur.ch);
					var clean = false;
					var is = { fa: 1, far: 1, fas: 1, fab: 1, fal: 1 };
					var space = is[text.substring(cur.ch - 2, cur.ch)] || is[text.substring(cur.ch - 3, cur.ch)];
					var reg = /(fal|far|fas|fab|fa)\s/;

					/*
					for (var i = cur.ch; i > cur.ch - 30; i--) {
						var fa2 = text.substring(i - 4, i);
						var fa = text.substring(i - 3, i);

						if (is[fa.trim()] || is[fa2.trim()]) {
							icon = icon.replace(reg, '');
							break;
						}
					}*/

					if (space || (selection && selection.indexOf(' ') === -1))
						icon = icon.replace(reg, '');

					editor.replaceSelection(prev && prev !== ' ' && prev !== ':' && prev !== '"' && prev !== '\'' ? (' ' + icon) : icon);
				});
			};

			SETTER('faicons/show', opt);
		};

		exports.options_editor = function(el) {

			var items = [];
			var is = !!code.editor.path;

			is && code.components && code.components.length && items.push({ value: 8, name: '@(Used parts)', icon: 'puzzle', shortcut: 'F2' });
			// is && items.push({ value: 10, name: '@(Insert snippet)', icon: 'paste', shortcut: 'F4' });
			is && (/js|css|html/).test(code.current.ext) && items.push({ value: 12, name: '@(Insert icon)', icon: 'images', shortcut: 'F6' });
			is && code.current.ext === 'css' && items.push({ value: 98, name: '@(Remove dark mode)', icon: 'adjust' });
			is && items.length && items.push('-');
			is && items.push({ value: 1, name: '@(Reload)', icon: 'refresh', shortcut: 'F5' });
			is && items.push({ value: 90, name: '@(Auto-reloader (5 sec.))', icon: 'refresh green' });
			is && items.push({ value: 2, name: '@(Find)', icon: 'search', command: 'find' });
			// is && items.push({ value: 2, name: '@(Replace)', icon: 'search', command: 'replaceAll' });
			is && items.push({ value: 11, name: '@(Localize current file)', icon: 'language' });
			is && items.push({ value: 3, name: '@(Convert to Tabs)', icon: 'align-right' });
			is && common.electron && code.data.repository && items.push({ value: 5, name: '@(Save locally)', icon: 'save' });
			is && items.push({ value: 4, name: '@(Restore from backup)', icon: 'history' });
			is && items.push({ value: 18, name: '@(Clear changes)', icon: 'recycle red' });
			is && items.push({ value: 99, name: '<strong>@(Code review)</strong>', icon: 'check-circle green' });
			is && items.push('-');
			is && code.data.pathsync && items.push({ value: 6, name: '@(Save synchronized)', icon: 'sync green' });
			common.electron && code.data.repository && items.push({ value: 7, name: '@(Download <strong>last changes locally</strong>)', icon: 'save' });
			common.electron && code.data.repository && items.push({ value: 22, name: '@(Download <strong>source-code locally</strong>)', icon: 'save' });
			items.push({ value: 13, name: common.showparts ? '@(Disable parts panel)' : '<strong>@(Enable parts panel)</strong>', icon: 'puzzle' + (common.showparts ? '' : ' green') });
			items.push({ value: 15, name: common.powermode ? '@(Disable power mode)' : '<strong>@(Enable power mode)</strong>', icon: 'flask' + (common.powermode ? '' : ' green') });
			items.push({ value: 25, name: common.totalcombat ? '@(Disable total combat)' : '<strong>@(Enable total combat)</strong>', icon: 'volume-up' });
			items.push({ value: 17, name: '@(To-Do list)', icon: 'check' });
			items.push({ value: 14, name: '@(Output panel)', icon: 'rss-square' });
			items.push({ value: 9, name: '@(Show log file)', icon: 'bug red', shortcut: 'F10' });
			items.push({ value: 16, name: '@(Clipboard)', icon: 'clipboard', shortcut: 'F11' });
			items.push({ value: 20, name: '@(Localize files)', icon: 'language' });
			items.push({ value: 96, name: '@(Diff resource tool)', icon: 'language' });
			items.push({ value: 97, name: '@(Reset windows)', icon: 'window-alt' });

			if (code.data.allowbundle && !code.data.isexternal)
	 			user.sa && items.push({ value: 23, name: '@(Download source-code)', icon: 'download' });

			items.push({ name: '@(Create Wiki)', icon: '!ti ti-book', value: 98 });

			if (code.data.allowbundle && !code.data.isexternal) {
				items.push('-');
				items.push({ value: 19, name: '@(Download bundle locally)', icon: 'box', classname: 'b' });
				code.data.pathsync && items.push({ value: 21, name: '@(Synchronize bundle)', icon: 'truck' });
			}

			SETTER('menu/show', 'left', el, items, function(item) {
				switch (item.value) {
					case 1:
						FUNC.editor_reload();
						break;
					case 96:
						EXEC('code/resourcediff');
						break;
					case 97:

						for (var key in PREF) {
							if (key.substring(0, 4) === 'win_')
								PREF.set(key);
						}

						var win = FIND('windows');
						var counter = 0;

						for (var item of windows) {
							var tmp = win.finditem(item.id);
							var minus = (counter++) * 50;
							tmp.setoffset(WW - (550 + minus), WH - (400 + minus));
							tmp.setsize(500, 250);
						}

						break;

					case 90:

						if (code.autorefresh) {
							code.autorefresh = null;
							return;
						}

						code.autorefresh = code.current.path;
						var autoreload = function() {
							if (code.autorefresh && code.current && code.current.path === code.autorefresh) {
								FUNC.editor_reload(true);
								setTimeout(autoreload, 5000);
							} else
								code.autorefresh = null;
						};

						setTimeout(autoreload, 5000);
						break;
					case 2:
						setTimeout(function() {
							editor.editor.focus();
							editor.editor.execCommand(item.command);
						}, 200);
						break;
					case 3:
						if (code.SYNC)
							FUNC.warning('@(You can\'t replace all spaces to tabs in collaboration mode.)');
						else
							editor.restore(FUNC.spaces_to_tabs(editor.editor.getValue()));
						break;
					case 4:
						SET('common.form', 'backups');
						break;
					case 12:
						exports.addicon();
						break;
					case 13:
						TOGGLE('common.showparts');
						break;
					case 15:
						TOGGLE('common.powermode');
						break;
					case 25:
						TOGGLE('common.totalcombat');
						common.totalcombat && FUNC.totalcombat('start');
						break;
					case 16:
						EXEC('code/clipboard');
						break;
					case 17:
						SET('common.form', 'tasks');
						break;
					case 20:
						EXEC('code/localize');
						break;
					case 14:
						SET('common.form', 'output');
						break;
					case 5:
						exports.savelocal();
						break;
					case 6:
						exports.save(false, true);
						break;
					case 7:
						exports.savelocalchanges();
						break;
					case 8:
						SET('common.form', 'components');
						break;
					case 9:
						exports.debug();
						break;
					case 10:
						SET('common.form', 'snippets');
						break;
					case 11:
						exports.translate();
						break;
					case 99:
						exports.review();
						break;
					case 18:
						exports.clearchanges();
						break;
					case 98:
						exports.makewiki();
						break;
					case 19:
						location.href = '/api/projects/{id}/bundle/'.arg(code.data);
						break;
					case 23:
						location.href = '/api/projects/{id}/download/'.arg(code.data);
						break;
					case 98:
						var cursor = editor.editor.getCursor(true);
						editor.restore(FUNC.removecssclass('.ui-dark', editor.editor.getValue()));
						editor.editor.setCursor(cursor, 200);
						editor.editor.focus();
						break;
					case 21:
						SETTER('loading/show');
						AJAX('GET /api/projects/{id}/bundle/'.arg(code.data), function() {
							SETTER('loading/hide', 1000);
							FUNC.success('@(Done, bundle has been synchronized.)');
						});
						break;
					case 22:
						exports.saveallfileslocally();
						break;
				}
			}, -5, -5);
		};

		exports.clearchanges = function() {

			AJAX('DELETE /api/projects/{id}/diff/'.arg(code.data) + '?path=' + encodeURIComponent(code.current.path));
			code.current.diff = [];
			editor.diffuserclear();

			/*
			if (!code.SYNC) {
				code.current.modified = false;
				editor.diffgutterclear();
				exports.element.find('section.tabs').find('span[data-value="{0}"]'.format(code.current.path)).rclass('modified');
				clearTimeout2('code.modified');
			}*/
		};

		exports.translate = function() {
			AJAX('GET /api/projects/{id}/translate/'.arg(code.data), { path: code.current.path }, function(response) {
				if (typeof(response) === 'string') {
					if (response) {
						setTimeout(ASETTER('clipboard/copy', response), 1000);
						FUNC.success('@(Localized dictionary has been copied into the clipboard.)');
					} else
						FUNC.warning('@(This file doesn\'t contain any localization markup.)');
				}
			});
		};

		exports.options = function(node, el) {

			var items = [];
			var ext = node.name;
			var index = ext.lastIndexOf('.');

			ext = index !== -1 ? ext.substring(index + 1).toLowerCase() : '';

			if (node.name === 'bundles')
				items.push({ value: 'bundles', name: '@(Download bundles)', icon: 'cloud-download', classname: 'b' });

			if (node.name === 'builds') {
				if (!node.children.findItem('name', 'app.build'))
					items.push({ makefile: true, name: '@(Create:) app.build', icon: 'paint-brush' });
			}

			if (node.name === 'definitions') {

				items.push({ value: 'definitions', name: '@(Download definitions)', icon: 'cloud-download', classname: 'b' });

				if (!node.children.findItem('name', 'init.js'))
					items.push({ makefile: true, name: '@(Create:) init.js', icon: 'file' });
				if (!node.children.findItem('name', 'auth.js'))
					items.push({ makefile: true, name: '@(Create:) auth.js', icon: 'file' });
				if (!node.children.findItem('name', 'db.js'))
					items.push({ makefile: true, name: '@(Create:) db.js', icon: 'file' });
				if (!node.children.findItem('name', 'func.js'))
					items.push({ makefile: true, name: '@(Create:) func.js', icon: 'file' });
				if (!node.children.findItem('name', 'main.js'))
					items.push({ makefile: true, name: '@(Create:) main.js', icon: 'file' });
				if (!node.children.findItem('name', 'service.js'))
					items.push({ makefile: true, name: '@(Create:) service.js', icon: 'file' });
			}

			if (node.children) {
				if (node.name === 'controllers') {
					if (!node.children.findItem('name', 'default.js'))
						items.push({ makefile: true, name: '@(Create:) default.js', icon: 'file' });
					if (!node.children.findItem('name', 'api.js'))
						items.push({ makefile: true, name: '@(Create:) api.js', icon: 'file' });
				}

				if (node.name === 'css') {
					if (!node.children.findItem('name', 'default.css'))
						items.push({ makefile: true, name: '@(Create:) default.css', icon: 'file' });
					if (!node.children.findItem('name', 'ui.css'))
						items.push({ makefile: true, name: '@(Create:) ui.css', icon: 'file' });
				}

				if (node.name === 'public') {
					if (!node.children.findItem('name', 'css'))
						items.push({ makedir: true, name: '@(Create:) css', icon: 'folder' });
					if (!node.children.findItem('name', 'forms'))
						items.push({ makedir: true, name: '@(Create:) forms', icon: 'folder' });
					if (!node.children.findItem('name', 'img'))
						items.push({ makedir: true, name: '@(Create:) img', icon: 'folder' });
					if (!node.children.findItem('name', 'js'))
						items.push({ makedir: true, name: '@(Create:) js', icon: 'folder' });
					if (!node.children.findItem('name', 'pages'))
						items.push({ makedir: true, name: '@(Create:) pages', icon: 'folder' });
					if (!node.children.findItem('name', 'panels'))
						items.push({ makedir: true, name: '@(Create:) panels', icon: 'folder' });
					if (!node.children.findItem('name', 'parts'))
						items.push({ makedir: true, name: '@(Create:) parts', icon: 'folder' });
					if (!node.children.findItem('name', 'templates'))
						items.push({ makedir: true, name: '@(Create:) templates', icon: 'folder' });
				}

				if (node.name === 'js') {
					if (!node.children.findItem('name', 'default.js'))
						items.push({ makefile: true, name: '@(Create:) default.js', icon: 'file' });
					if (!node.children.findItem('name', 'func.js'))
						items.push({ makefile: true, name: '@(Create:) func.js', icon: 'file' });
					if (!node.children.findItem('name', 'helpers.js'))
						items.push({ makefile: true, name: '@(Create:) helpers.js', icon: 'file' });
					if (!node.children.findItem('name', 'ui.js'))
						items.push({ makefile: true, name: '@(Create:) ui.js', icon: 'file' });
				}

				if (node.name === 'resources') {
					if (!node.children.findItem('name', 'default.resource'))
						items.push({ makefile: true, name: '@(Create:) default.resource', icon: 'file' });
				}
			}

			var tmp = node.path.split('/').trim();
			if (tmp[0] === 'plugins' && tmp[1] && !tmp[2]) {
				if (tmp[1].lastIndexOf('.html') === -1) {
					// directory
					items.push({ value: 'plugin_compress', name: '@(Convert to <strong>{0}</strong>)'.format(tmp[1] + '.html'), icon: 'plug' });
				} else {
					// file
					items.push({ value: 'plugin_extract', name: '@(Expose plugin)', icon: 'plug' });
				}
			}

			if (items.length)
				items.push('-');

			if (node.name === 'packages') {
				items.push({ value: 'packages', name: '@(Download packages)', icon: 'cloud-download', classname: 'b' });
				items.push('-');
			}

			if (node.name === 'modules') {
				items.push({ value: 'modules', name: '@(Download modules)', icon: 'cloud-download', classname: 'b' });
				items.push('-');
			}

			if (node.name === 'schemas') {
				items.push({ value: 'schemas', name: '@(Download schemas)', icon: 'cloud-download', classname: 'b' });
				items.push('-');
			}

			if (node.name === 'operations') {
				items.push({ value: 'operations', name: '@(Download operations)', icon: 'cloud-download', classname: 'b' });
				items.push('-');
			}

			if (node.children) {
				items.push({ value: 'filter', name: '@(Show this folder only)', icon: 'filter green' });
				items.push({ value: 'file', name: '@(Create file)', icon: '!ti ti-file' });
				items.push({ value: 'directory', name: '@(Create directory)', icon: '!ti ti-folder' });
			} else {

				items.push({ value: 'download', name: '@(Download file)', icon: 'cloud-download', classname: 'b' });

				if (common.electron)
					items.push({ value: 'sync', name: '@(Download file locally)', icon: 'code-branch' });

				items.push({ value: 'metainfo', name: '@(Read info)', icon: 'info-circle' });

				if (ext === 'gz' || ext === 'zip')
					items.push({ value: 'unpack', name: '@(Unpack)', icon: 'ti ti-box' });

				if (ext === 'flow' || ext === 'build' || ext === 'ui')
					items.push({ value: 'editbody', name: '@(Edit)', icon: 'file' });

				items.push('-');
			}

			items.push({ value: 3, name: '@(Rename)', icon: 'pencil' });
			items.push({ value: node.children ? 22 : 2, name: '@(Duplicate)', icon: 'copy' });
			items.push({ value: 255, name: '@(Remove)', icon: 'times-circle red' });

			var path = node.path;

			SETTER('menu/show', 'right', el, items, function(item) {

				if (item.makefile) {
					var name = path + item.name.substring(item.name.indexOf(':') + 1).trim();
					SET('code.statusform.name', '');
					if (!code.statusform)
						code.statusform = {};
					code.statusform.path = '';
					exports.statusform('file', name);
					return;
				}

				if (item.makedir) {
					var name = path + item.name.substring(item.name.indexOf(':') + 1).trim() + '/';
					SET('code.statusform.name', '');
					if (!code.statusform)
						code.statusform = {};
					code.statusform.path = '';
					exports.statusform('directory', name);
					return;
				}

				switch (item.value) {
					case 'editbody':
						exports.open(node, true);
						break;
					case 'sync':
						exports.syncfilelocally(node.path, function(err) {
							if (err)
								SETTER('notifybar/warning', err);
							else
								SETTER('notifybar/success', '@(The file has been synchronized)');
						});
						break;
					case 'unpack':
						AJAX('POST /api/files/{id}/unpack/'.arg(code.data), { filename: node.path }, ASETTER('message/response', function() {
							exports.refresh();
						}));
						break;
					case 'plugin_compress':
					case 'plugin_extract':
						FUNC[item.value](node.path, exports.refresh);
						break;
					case 'filter':
						SETTER('tree/shownested', node.path);
						break;
					case 'download':
						location.href = '/api/download/' + code.data.id + '/?path=' + encodeURIComponent(path);
						break;
					case 'metainfo':

						if (common.isinfopanel)
							return;

						AJAX('GET /api/metainfo/' + code.data.id + '/?path=' + encodeURIComponent(path), function(response) {
							common.isinfopanel = true;
							response.mode = '0' + (response.mode & parseInt('777', 8)).toString(8);
							SETTER('infopanel/show', el, function(el) {
								el.html('<div class="metainfo"><b><i class="ti ti-file"></i> {4}</b>Size: {0}<br />Mode: {1}<br />Modified: {2}<br />Created: {3}</div>'.format(response.size.filesize(), response.mode, new Date(response.mtimeMs).format(), new Date(response.ctimeMs).format(), path));
							}, -10, -105, false, function() {
								common.isinfopanel = false;
							});
						});
						break;
					case 'bundles':
					case 'packages':
					case 'modules':
					case 'schemas':
					case 'operations':
					case 'definitions':
						SET('common.form', item.value);
						break;
					case 'file':
					case 'directory':
						SET('code.statusform.name', item.value);
						code.statusform.path = node.path + (node.path ? '/' : '');
						break;

					case 2:
						// Duplicate
						var name = node.path;

						var index = name.lastIndexOf('.');
						if (index === -1) {
							name += '-2';
						} else
							name = name.substring(0, index) + '-2' + name.substring(index);

						SET('code.statusform.name', 'file');
						SETTER('statusform/val', name, node.path);
						break;

					case 22:
						// Duplicate
						var name = node.path;

						var index = name.lastIndexOf('/');
						if (index === -1) {
							name += '-2';
						} else
							name = name.substring(0, index) + '-2/';

						SET('code.statusform.name', 'directory');
						SETTER('statusform/val', name, node.path);
						break;

					case 3:
						setTimeout(function() {
							exports.element.SETTER('tree/rename', node.$pointer);
						}, 500);
						break;
					case 255:
						SETTER('approve/show', '@(Are you sure you want to remove <b>{0}</b>?)'.format(node.path), '"trash" @(Remove)', function() {
							var data = {};
							data.path = node.path;
							SETTER('loading/show');
							AJAX('POST /api/files/{id}/remove/'.arg(code.data), data, function() {
								SETTER('loading/hide', 100);
								FUNC.success('@(Removed successfully: <b>{0}</b>)'.format(data.path));
								var el = exports.element.find('.tabs');
								el = el.find('span[data-value="{0}"]'.format(data.path));
								el.length && el.find('i').trigger('click');
								SET('code.tree', FUNC.treeremove(code.tree, node.path));
								code.data.files = code.data.files.remove(node.path);
								common.electron && code.data.repository && user.localsave && FUNC.unlinkpath(require('path').join(FUNC.getName(code.data.repository.replace(/\.git$/i, '')), node.path));
							});
						});
						break;
				}
			}, 20, -30);
		};

		exports.close = function(el, e) {
			var path = code.current ? code.current.path : '';
			if (el instanceof jQuery)
				path = el.parent().attrd('value');
			var tab = code.open.findItem('path', path);
			if (tab) {
				if (tab.modified) {
					SETTER('approve/show', '@(The content has been modified. <b>Do you want to <u>discard changes</u>?</b>)', '"trash" @(Discard changes)', function() {
						exports.closeforce(tab.path);
					});
				} else
					exports.closeforce(tab.path);
			}
		};

		exports.closeforce = function(path) {
			exports.closetab(path || code.current.path);
		};

		exports.closetab = function(path) {

			var tab = code.open.findItem('path', path);
			if (tab == null)
				return;

			var index = code.open.indexOf(tab);
			code.open.splice(index, 1);
			exports.cache_rem(tab.path);

			// In some cases can be name of tab null
			var tmpindex = 0;
			while (true) {
				var open = code.open[tmpindex];
				if (!open)
					break;
				if (open.name)
					tmpindex++;
				else
					code.open.splice(tmpindex, 1);
			}

			var tmpindex = code.open.findIndex('name', null);
			if (tmpindex !== -1)
				code.open.splice(tmpindex, 1);

			UPDATE('code.open');

			if (tab.path === code.editor.path) {
				if (code.open.length) {
					if (index - 1 > -1)
						index -= 1;
					else
						index = 0;
					exports.opentab(code.open[index].path);
				} else {
					FUNC.wsopen(code.data.id, '');
					$('#body').rclass('warning');
					SET('code.data.todocurrent', []);
					SET('code.editor', {});
					SET('code.multiple', false);
					SET('code.backup', false);
					SET('code.current.lastmodified', null);
					exports.element.RECONFIGURE('editor', 'disabled:true');
					NULL('code.current', 300);
				}
			}

			exports.savetabs();
		};

		exports.edit = function(tab, serverside) {

			if (!editor) {
				exports.edit(tab, serverside);
				return;
			}

			if (typeof(tab) === 'string')
				tab = code.open.findItem('path', tab);

			var prev = GET('code.editor.path');
			if (prev && prev !== tab.path && editor) {
				prev = code.open.findItem('path', prev);
				if (prev)
					prev.doc = editor.copy(true);
			}

			code.editor.loaded = false;

			if (!tab.reload)
				editor && editor.clear(true);

			var ext = tab.path.substring(tab.path.lastIndexOf('.') + 1).toLowerCase();
			var mode;

			if (tab.path === '/.bundlesignore' || tab.path === '/.bundleignore') {
				mode = 'totaljsbundle';
			} else {
				switch (ext) {
					case 'src/config':
					case 'src/config-release':
					case 'src/config-debug':
					case 'src/config-test':
					case 'src/versions':
					case 'src/dependencies':
					case 'src/sitemap':
					case 'src/workflows':
					case '/config':
					case '/config-release':
					case '/config-debug':
					case '/config-test':
					case '/versions':
					case '/dependencies':
					case '/sitemap':
					case '/workflows':
					case 'resource':
					case 'package':
					case 'bundle':
						mode = 'totaljsresources';
						break;
					case 'properties':
						mode = 'properties';
						break;
					case 'env':
						mode = 'env';
						break;
					case 'todo':
						mode = 'todo';
						break;
					case 'js':
						mode = 'totaljs_server';
						break;
					case 'api':
						mode = 'codeapi';
						break;
					case 'json':
					case 'ui':
					case 'nosql':
						mode = 'application/ld+json';
						break;
					case 'py':
						mode = 'text/x-cython';
						break;
					case 'php':
						mode = 'application/x-httpd-php';
						break;
					case 'css':
						mode = 'text/css';
						break;
					case 'c':
						mode = 'text/x-csrc';
						break;
					case 'cpp':
						mode = 'text/x-c++src';
						break;
					case 'sql':
						mode = 'text/x-sql';
						break;
					case 'sh':
						mode = 'text/x-sh';
						break;
					case 'md':
						mode = 'markdown';
						break;
					case 'sass':
						mode = 'text/x-sass';
						break;
					case 'yaml':
						mode = 'text/x-yaml';
						break;
					case 'xml':
					case 'rss':
						mode = 'application/xml';
						break;
					case 'html':
					case 'htm':
						mode = 'totaljs';
						break;
					case 'ts':
						mode = 'text/typescript';
						break;
					default:
						mode = 'plain';
						break;
				}
			}

			SET('code.editor.path', tab.path);
			SET('code.editor.name', tab.name);
			code.editor.hash = HASH(tab.path);
			code.projectid = HASH(code.data.id + '_' + tab.path);

			if (common.form === 'backups')
				EXEC('codebackups/refresh');

			var reload = tab.reload;

			var change = code.changes[code.projectid];
			if (change && tab.doc) {
				exports.syncsave(change);
				code.changes[code.projectid] = null;
			}

			if (JSHINT.errors) {
				JSHINT.errors.length = 0;
				SET('code.errors', EMPTYARRAY);
			}

			if (tab.doc) {
				SET('code.editor.body @reset', tab.body, 'skip');
				editor.paste(tab.doc);
			} else {

				editor.clear();

				if (reload) {
					editor.editor.replaceRange(tab.body, { ch: 0, line: 0 }, { ch: 0, line: editor.editor.doc.lineCount() + 1 });
					tab.reload = false;
				} else {
					SET('code.editor.body @reset', tab.body, 2);
					editor.paste(editor.copy(false));
				}

				var history = editor.editor.doc.history;
				history.done.pop();
				history.done.pop();
			}

			if (!tab.iswatcher)
				setTimeout2('code.autocomplete', editor.rebuild_autocomplete, 1000);

			code.current = tab;

			if (!reload)
				editor.reconfigure('disabled:false;mode:' + mode);

			code.SYNCUSER = null;
			code.SYNCID = null;

			if (!tab.iswatcher)
				FUNC.wsopen(code.data.id, code.current.path, code.projectid);

			code.editor.loaded = true;
			code.editor.loadedcache = false;

			!tab.doc && setTimeout(function() {
				editor.editor.refresh();
				exports.restoreposition();
				code.editor.loadedcache = true;
			}, 250);

			if (!tab.iswatcher) {
				(function(tab) {
					AJAX('GET /api/projects/{id}/diff/'.arg(code.data), { path: tab.path }, function(response) {
						tab.diff = response;
						if (code.current && tab.path === code.current.path)
							UPD('code.current.diff');
					});
				})(tab);

				// Refresh tasks
				exports.changelog();
			} else
				tab.iswatcher = false;
		};

		exports.restoreposition = function(cursoronly) {

			if (!code.current)
				return;

			var cache = exports.cache_getscroll(code.current.path);
			if (cache) {
				editor.editor.setCursor({ line: cache.line || 0, ch: cache.ch || 0 });
				if (!cursoronly)
					editor.editor.scrollTo(cache.x || 0, cache.y || 0);
				editor.editor.focus();
			} else {
				if (!cursoronly)
					editor.editor.scrollTo(0, 0);
				editor.editor.setCursor(0);
			}
		};

		exports.changelog = function() {

			// In some cases can be null
			if (!code.current)
				return;

			AJAX('GET /api/projects/{id}/changelog/'.arg(code.data), { path: code.current.path }, function(response) {
				if (code.current && code.current.lastmodified && response) {
					var tmp = code.current.lastmodified;
					if (response.user && response.user !== user.name && (tmp.user !== response.user || tmp.updated.getTime() !== response.updated.getTime())) {
						FUNC.info('@(<b>{0}</b> changed this file <b>{1}</b>.)'.format(response.user, Thelpers.time(response.updated)));
						if (!code.SYNC && code.usersfile && code.usersfile.length === 1) {
							SETTER('loading/show');
							SETTER('loading/hide', 1000);
							FUNC.editor_reload();
						}
					}
				}
				SET('code.current.lastmodified', response);
			});
		};

		exports.load = function(id, skip, callback) {

			SETTER('loading/show');

			if (callback instanceof jQuery)
				callback = null;

			if (code.data && code.data.id !== id)
				FUNC.wsopen(id, '');

			AJAX('GET /api/projects/{0}/files/'.format(id), function(response) {

				exports.scope();
				SETTER('loading/hide', 1000);

				if (response instanceof Array) {
					FUNC.warning(response);
					NUL('?.data');
					NUL('?.tree');
					callback && callback();
					return;
				}

				var compare = W.Intl.Collator().compare;

				var sort = function(a, b) {
					var namea = a.split(/_|-/).join('X');
					var nameb = b.split(/_|-/).join('X');
					return compare(namea, nameb);
				};

				response.directories.sort(sort);
				response.files.sort(sort);

				var tree = [];

				for (var i = 0; i < response.directories.length; i++)
					FUNC.treeappend(tree, response.directories[i]);

				for (var i = 0; i < response.files.length; i++)
					FUNC.treeappend(tree, response.files[i], true);

				var item = tree.findItem('name', '#');
				if (item) {
					tree = tree.remove('name', '#');
					for (var i = 0; i < item.children.length; i++)
						tree.push(item.children[i]);
				}

				if (!skip)
					exports.element.SETTER('tree', 'clear');

				var todo = {};

				if (response.todo) {
					for (var i = 0; i < response.todo.length; i++) {
						var item = response.todo[i];
						if (todo[item.path])
							todo[item.path].push(item);
						else
							todo[item.path] = [item];
					}
				}

				var keys = Object.keys(todo);

				response.todo = [];
				keys.sort();

				for (var i = 0; i < keys.length; i++) {
					var obj = {};
					obj.path = keys[i];
					obj.items = todo[obj.path];
					response.todo.push(obj);
				}

				SET('document.title', common.name + ': ' + response.name);
				SET('code.data', response);
				SET('code.tree', tree);

				W.WSLIVERELOAD && W.WSLIVERELOAD.close();
				W.WSLIVERELOAD = null;

				if (response.livereload)
					setTimeout(FUNC.livereloadconnect, 1000);

				if (!skip) {
					SET('code.editor', {});
					SET('code.open', []);
					SET('code.usersproject', EMPTYARRAY);
					SET('code.usersfile', EMPTYARRAY);
					SET('code.multiple', false);
					$('#body').rclass('warning');
					setTimeout(exports.restoretabs, 500);
				}

				AJAX('GET /api/projects/{id}/changes/'.arg(code.data), { recent: 1 }, function(response) {
					var arr = [];
					var cache = {};
					for (var i = 0; i < response.length; i++) {
						var file = response[i];

						if (code.data.files.indexOf(file.path) === -1)
							continue;

						if (!cache[file.path]) {
							cache[file.path] = 1;
							arr.push(file);
						}
						if (arr.length > 4)
							break;
					}

					SET('code.recent', arr);
					EXEC('codechanges/refresh');
					EXEC('codebackups/refresh');
				});

				AJAX('GET /api/projects/{0}/parts/'.format(id), 'code.componentsdb');
				callback && callback();
			});
		};

		exports.projects = function(el) {

			var opt = {};
			opt.element = el;
			opt.items = code.projects;

			for (var i = 0; i < opt.items.length; i++) {
				var item = opt.items[i];
				item.template = '<i class="{0}"></i>{{ if online }}<span>{{ online }}</span>{{ fi }}{{ name }}'.format(item.pinned ? 'ti ti-pin-alt orange' : 'ti ti-code-branch');
				item.classname = code.data && code.data.id === item.id ? 'ui-directory-current' : '';
			}

			opt.offsetWidth = 300;
			opt.offsetY = 10;
			opt.offsetX = 10;
			opt.class = 'ui-directory-projects';

			opt.callback = function(item) {
				common.recent = common.recent.remove('id', item.id);
				if (common.recent.length > 20)
					common.recent.pop();
				PUSH('^common.recent', { id: item.id, name: item.name });
				if (item && item.id)
					REDIRECT('/?id=' + item.id);
			};

			SETTER('directory/show', opt);
		};

		exports.loadproject = function(el) {
			REDIRECT('/?id=' + el.attrd('id'));
		};

		exports.savelocal = function(nowarning, path, val) {

			var ext = code.current ? code.current.ext : '';

			if (typeof(path) !== 'string') {
				path = code.editor.path;
				val = editor.editor.getValue();
			} else
				ext = path.substring(path.lastIndexOf('.') + 1);

			var electronpath = require('electron').ipcRenderer.sendSync('getPath', { url: location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '') });
			if (electronpath) {
				var Path = require('path');
				var filename = Path.join(electronpath, code.data.repository.replace(/\.git$/i, ''), path);
				FUNC.mkdir(Path.dirname(filename));
				require('fs').writeFile(filename, code.NOTRIM[ext] ? val : FUNC.rtrim(val), function(err) {
					if (err)
						FUNC.warning(err.toString());
					// else
					// 	FUNC.success('<b>{0}</b> saved successfully.'.format(filename));
				});
			} else if (!nowarning)
				FUNC.warning('@(You don\'t have defined repository path.)');
		};

		exports.local = function(callback) {
			var electronpath = require('electron').ipcRenderer.sendSync('getPath', { url: location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '') });
			electronpath && callback(electronpath);
		};

		exports.savelocalchanges = function(nowarning) {
			var electronpath = require('electron').ipcRenderer.sendSync('getPath', { url: location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '') });
			if (electronpath) {

				var Path = require('path');
				var Https = require('https');
				var Http = require('http');
				var Fs = require('fs');

				SETTER('loading/show');
				AJAX('GET /api/projects/{id}/changelogs/'.arg(code.data), function(response) {

					response.wait(function(item, next, index) {

						SET('common.percentage', (index / response.length) * 100);

						var filename = Path.join(electronpath, code.data.repository.replace(/\.git$/i, ''), item.path);

						if (item.removed) {
							SETTER('loading/show', ('<b style="font-size:18px">{0}%</b><br /><b>@(Removing:)</b> ' + item.path).format(common.percentage >> 0));
							Fs.unlink(filename, next);
						} else {

							SETTER('loading/show', ('<b style="font-size:18px">{0}%</b><br /><b>@(Saving:)</b> ' + item.path).format(common.percentage >> 0));

							FUNC.mkdir(Path.dirname(filename));

							var resume = function() {
								setTimeout(next, 300);
							};

							var url = location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '') + '/api/download/{id}/?path='.arg(code.data) + encodeURIComponent(item.path);
							var res = function(res) {

								if (res.statusCode !== 200) {
									resume();
									return;
								}

								res.on('error', resume);
								res.on('end', resume);
								res.pipe(Fs.createWriteStream(filename));
							};

							url = require('url').parse(url);
							url.headers = {};
							url.headers['user-agent'] = navigator.userAgent;
							url.headers.cookie = '@{config.cookie}=' + COOKIES.get('@{config.cookie}');

							if (location.protocol === 'https:')
								Https.get(url, res);
							else
								Http.get(url, res);
						}

					}, function() {
						SET('common.percentage', 100);
						SETTER('loading/hide');
					});
				});

			} else if (!nowarning)
				FUNC.warning('@(You don\'t have defined repository path.)');
		};

		exports.syncfilelocally = function(filename, callback) {

			var electronpath = require('electron').ipcRenderer.sendSync('getPath', { url: location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '') });
			if (!electronpath) {
				callback && callback('@(You don\'t have defined repository path.)');
				return;
			}

			var Path = require('path');
			var Https = require('https');
			var Http = require('http');
			var Fs = require('fs');
			var filesaveto = Path.join(electronpath, code.data.repository.replace(/\.git$/i, ''), filename);

			FUNC.mkdir(Path.dirname(filesaveto));

			var resume = function() {
				callback && callback();
			};

			var url = location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '') + '/api/download/{id}/?path='.arg(code.data) + encodeURIComponent(filename);
			var res = function(res) {

				if (res.statusCode !== 200) {
					resume('@(Unexpected HTTP error: {0})'.format(res.statusCode));
					return;
				}

				res.on('error', resume);
				res.on('end', resume);
				res.pipe(Fs.createWriteStream(filesaveto));
			};

			url = require('url').parse(url);
			url.headers = {};
			url.headers['user-agent'] = navigator.userAgent;
			url.headers.cookie = '@{config.cookie}=' + COOKIES.get('@{config.cookie}');

			if (location.protocol === 'https:')
				Https.get(url, res);
			else
				Http.get(url, res);
		};

		exports.saveallfileslocally = function(nowarning) {

			var electronpath = require('electron').ipcRenderer.sendSync('getPath', { url: location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '') });
			if (electronpath) {

				var Path = require('path');
				var Https = require('https');
				var Http = require('http');
				var Fs = require('fs');

				SETTER('loading/show');
				code.data.files.wait(function(item, next, index) {

					SET('common.percentage', (index / code.data.files.length) * 100);
					var filename = Path.join(electronpath, code.data.repository.replace(/\.git$/i, ''), item);

					SETTER('loading/show', ('<b style="font-size:18px">{0}%</b><br /><b>@(Saving:)</b> ' + item).format(common.percentage >> 0));
					FUNC.mkdir(Path.dirname(filename));

					var resume = function() {
						setTimeout(next, 300);
					};

					var url = location.protocol + '//' + location.hostname + (location.port ? ':' + location.port : '') + '/api/download/{id}/?path='.arg(code.data) + encodeURIComponent(item);
					var res = function(res) {
						if (res.statusCode === 200) {
							res.on('error', resume);
							res.on('end', resume);
							res.on('abort', resume);
							res.pipe(Fs.createWriteStream(filename));
						} else
							resume();
					};

					url = require('url').parse(url);
					url.headers = {};
					url.headers['user-agent'] = navigator.userAgent;
					url.headers.cookie = '@{config.cookie}=' + COOKIES.get('@{config.cookie}');

					if (location.protocol === 'https:')
						Https.get(url, res);
					else
						Http.get(url, res);

				}, function() {
					SET('common.percentage', 100);
					SETTER('loading/hide');
				});

			} else if (!nowarning)
				FUNC.warning('@(You don\'t have defined repository path.)');
		};

		exports.save = function(close, sync) {

			if (!code.current || BLOCKED('code_saving', 1000))
				return;

			SETTER('loading/show');

			setTimeout(function() {

				editor.flush();

				var now = Date.now();
				var data = {};
				var val = editor.editor.getValue();
				var changes = 0;
				var changesdiff = $('.cm-diff');

				for (var i = 0; i < changesdiff.length; i++) {
					if (!HIDDEN(changesdiff[i]))
						changes++;
				}

				data.body = code.NOTRIM[code.current.ext] ? val : FUNC.rtrim(val);

				if (changes && (!code.lastchange || (now - code.lastchange) > 10000))
				 	FUNC.totalcombat('welldone');

				var hashsum = HASH(data.body);
				if (hashsum === code.current.hashsum && !changes) {
					code.current.hashsum = hashsum;
					data = {};
					data.path = code.editor.path;

					if (sync)
						data.sync = sync;

					AJAX('GET /api/projects/{id}/modify/ REPEAT'.arg(code.data), data, ASETTER('message/response', function(response) {
						FUNC.success((response.value === 'synchronized' ? '@(<b>{0}</b> saved and synchronized.)' : '@(<b>{0}</b> saved successfully.)').format(data.path));
						common.electron && code.data.repository && user.localsave && exports.savelocal();
						SETTER('loading/hide');
						editor.diffgutterclear();
						FUNC.livereload(data.path);
					}));

					return;
				}

				var isminified = /(\.|-)min(\.|@|-)/.test(code.editor.path) || (/\.(log|txt|md)$/).test(code.editor.path);

				data.diff = editor.getDiff();
				data.changes = changes;
				data.path = code.editor.path;
				data.combo = isminified ? 0 : FIND('combo').summarize();
				data.todo = isminified ? EMPTYARRAY : code.data.todocurrent && code.data.todocurrent.length ? code.data.todocurrent : null;
				data.parts = isminified || code.editor.path.substring(0, 9) === '/scripts/' || code.editor.path === '/modules/code.js' ? EMPTYARRAY : code.components;

				// Update hashsum
				code.data.hashsum = hashsum;

				if (!isminified) {
					var parts = code.componentsdb.findItem('path', data.path);
					if (parts == null) {
						parts = {};
						parts.path = data.path;
						parts.items = data.parts;
						code.componentsdb.push(parts);
					} else
						parts.items = data.parts;

					UPD('code.componentsdb');
				}

				if (code.current.diff)
					code.current.diff = data.diff;

				// Time is sent in seconds

				var diff = Math.ceil((now - code.lastchange) / 1000);
				var max = 80; // minutes

				if ((diff / 60) < max)  // minutes
					data.time = Math.ceil((now - code.current.time) / 1000);
				else
					data.time = Math.ceil((code.lastchange - code.current.time) / 1000);

				// Limit
				if (data.time > ((max + 1) * 60))
					data.time = (max + 1) * 60;

				if (common.plustimespent)
					data.time += common.plustimespent;

				code.current.time = now;
				code.lastchange = now;

				if (sync)
					data.sync = sync;

				code.current.modified = false;
				exports.cache_rem(code.current.path);
				exports.element.find('section.tabs').find('span[data-value="{0}"]'.format(code.current.path)).rclass('modified');

				// Internal timers
				clearTimeout2('code.modified');
				clearTimeout2('EditorGutterColor');

				AJAX('POST /api/files/{id}/ REPEAT'.arg(code.data), data, ASETTER('message/response', function(response) {

					SETTER('loading/hide', 500);

					if (close === true)
						exports.closeforce();

					FUNC.wssend({ TYPE: 'save', connid: common.id, projectid: code.projectid, id: user.id, user: user.name });
					FUNC.success((response.value === 'synchronized' ? '@(<b>{0}</b> saved and synchronized.)' : '@(<b>{0}</b> saved successfully.)').format(data.path));
					common.electron && code.data.repository && user.localsave && exports.savelocal();
					SET('code.current.lastmodified', { user: user.name, updated: new Date() });
					data.diff.length && UPD('code.current.diff');
					editor.diffgutterclear();
					FUNC.livereload(data.path);
				}));

			}, 300);
		};

		exports.readfile = function(path, callback) {
			AJAX('GET /api/projects/{id}/edit/'.arg(code.data), { path: path }, callback);
		};

		exports.savefile = function(path, body, callback) {

			var data = {};
			data.diff = [];
			data.changes = [];
			data.path = path;
			data.combo = 0;
			data.body = body;
			data.todo = EMPTYARRAY;
			data.parts = EMPTYARRAY;

			exports.cache_rem(data.path);
			exports.element.find('section.tabs').find('span[data-value="{0}"]'.format(data.path)).rclass('modified');
			SETTER('loading/show');
			AJAX('POST /api/files/{id}/ REPEAT'.arg(code.data), data, ASETTER('message/response', function(response) {
				SETTER('loading/hide', 500);
				FUNC.wssend({ TYPE: 'save', connid: common.id, projectid: code.projectid, id: user.id, user: user.name });
				common.electron && code.data.repository && user.localsave && exports.savelocal();
				FUNC.livereload(data.path);
				callback && callback();
			}));
		};

		exports.removefile = function(path, callback) {

			var data = {};
			data.path = path;
			SETTER('loading/show');
			AJAX('POST /api/files/{id}/remove/'.arg(code.data), data, function() {
				SETTER('loading/hide', 100);
				var el = exports.element.find('.tabs');
				el = el.find('span[data-value="{0}"]'.format(data.path));
				el.length && el.find('i').trigger('click');
				SET('code.tree', FUNC.treeremove(code.tree, data.path));
				code.data.files = code.data.files.remove(data.path);
				common.electron && code.data.repository && user.localsave && FUNC.unlinkpath(require('path').join(FUNC.getName(code.data.repository.replace(/\.git$/i, '')), data.path));
				callback && callback();
			});

		};

		exports.savetabs = function() {

			var arr = [];

			if (code.current) {
				for (var i = 0; i < code.open.length; i++) {
					var tab = code.open[i];
					var data = {};
					data.path = tab.path;
					if (tab) {
						if (tab.path === code.current.path)
							data.focused = true;
						arr.push(data);
					}
				}
			}

			localStorage.setItem(code.data.id + '_tabs', STRINGIFY(arr));
		};

		exports.restoretabs = function() {
			var open = localStorage.getItem(code.data.id + '_tabs');
			if (!open)
				return;

			open = PARSE(open);

			var selected = null;
			var tabs = [];

			for (var i = 0; i < open.length; i++) {
				var tab = open[i];
				var fileindex = code.data.files.indexOf(tab.path);
				if (fileindex !== -1) {
					tab.name = code.data.files[fileindex];
					if (tab.name) {
						tab.name = FUNC.maketabname(tab.path);
						tab.body = '';
						tab.skip = true;
						tabs.push(tab);
					}

					if (tab.focused) {
						delete tab.focused;
						selected = tab;
					}
				}
			}

			tabs.length && SET('code.open', tabs);
			selected && exports.open({ children: null, path: selected.path, name: selected.name }, true);
		};

		var colorclasses = {};

		exports.collaboration = function(msg) {

			if (code.data == null)
				return;

			if (msg.projectid === code.data.id)
				SET('code.usersproject', msg.project);

			if (code.editor && msg.projectid === code.data.id && msg.fileid === code.editor.path) {
				SET('code.usersfile', msg.file);
				var colors = [];
				for (var i = 0; i < msg.file.length; i++) {
					var usr = msg.file[i];
					usr.color = Thelpers.initials(usr.name, true);
				}
				colors.length && CSS(colors.join(''));
			}

			if (code.editor && msg.fileid === code.editor.path) {

				editor && editor.clearmarkers();
				$('#body').tclass('warning', code.usersfile && code.usersfile.length > 1);

				var is = !!(code.usersfile && code.usersfile.length > 1);
				SET('code.multiple', is);

				// auto-sync
				if (is) {
					if (common.id === msg.connid) {
						code.issyncing = true;
						SETTER('loading/show');
						setTimeout(exports.syncdata, 1000);
					}
				}
			}
		};

		exports.statusform = function(name, value, type) {

			if (name instanceof jQuery) {

				var dname = name.attrd('name');
				var opt;

				if (dname === 'directory') {
					opt = {};
					opt.element = name;
					opt.offsetY = -1;
					opt.offsetX = 0;
					opt.position = 'bottom';
					opt.items = [];

					var directory = {};

					for (var i = 0; i < code.tree.length; i++)
						directory[code.tree[i].name] = 1;

					if (!directory.actions)
						opt.items.push({ name: '<strong>@(Create):</strong> /actions', icon: '!ti ti-folder', value: '/actions/' });

					/*
					if (!directory.builds)
						opt.items.push({ name: '<strong>@(Create):</strong> /builds', icon: '!ti ti-folder', value: '/builds/' });
						*/

					if (!directory.bundles)
						opt.items.push({ name: '<strong>@(Create):</strong> /bundles', icon: '!ti ti-folder', value: '/bundles/' });

					/*
					if (!directory.components)
						opt.items.push({ name: '<strong>@(Create):</strong> /components', icon: '!ti ti-folder', value: '/components/' });
					*/

					if (!directory.controllers)
						opt.items.push({ name: '<strong>@(Create):</strong> /controllers', icon: '!ti ti-folder', value: '/controllers/' });

					if (!directory.databases)
						opt.items.push({ name: '<strong>@(Create):</strong> /databases', icon: '!ti ti-folder', value: '/databases/' });

					if (!directory.definitions)
						opt.items.push({ name: '<strong>@(Create):</strong> /definitions', icon: '!ti ti-folder', value: '/definitions/' });

					if (!directory.extensions)
						opt.items.push({ name: '<strong>@(Create):</strong> /extensions', icon: '!ti ti-folder', value: '/extensions/' });

					if (!directory.jsonschemas)
						opt.items.push({ name: '<strong>@(Create):</strong> /jsonschemas', icon: '!ti ti-folder', value: '/jsonschemas/' });

					/*

					if (!directory.middleware)
						opt.items.push({ name: '<strong>@(Create):</strong> /middleware', icon: '!ti ti-folder', value: '/middleware/' });

					if (!directory.models)
						opt.items.push({ name: '<strong>@(Create):</strong> /models', icon: '!ti ti-folder', value: '/models/' });*/

					if (!directory.modules)
						opt.items.push({ name: '<strong>@(Create):</strong> /modules', icon: '!ti ti-folder', value: '/modules/' });

					/*
					if (!directory.operations)
						opt.items.push({ name: '<strong>@(Create):</strong> /operations', icon: '!ti ti-folder', value: '/operations/' });

					if (!directory.packages)
						opt.items.push({ name: '<strong>@(Create):</strong> /packages', icon: '!ti ti-folder', value: '/packages/' });*/

					if (!directory.plugins)
						opt.items.push({ name: '<strong>@(Create):</strong> /plugins', icon: '!ti ti-folder', value: '/plugins/' });

					if (!directory.private)
						opt.items.push({ name: '<strong>@(Create):</strong> /private', icon: '!ti ti-folder', value: '/private/' });

					if (!directory.public)
						opt.items.push({ name: '<strong>@(Create):</strong> /public', icon: '!ti ti-folder', value: '/public/' });

					if (!directory.resources)
						opt.items.push({ name: '<strong>@(Create):</strong> /resources', icon: '!ti ti-folder', value: '/resources/' });

					if (!directory.schemas)
						opt.items.push({ name: '<strong>@(Create):</strong> /schemas', icon: '!ti ti-folder', value: '/schemas/' });

					if (!directory.transforms)
						opt.items.push({ name: '<strong>@(Create):</strong> /transforms', icon: '!ti ti-folder', value: '/transforms/' });

					/*
					if (!directory.scripts)
						opt.items.push({ name: '<strong>@(Create):</strong> /scripts', icon: '!ti ti-folder', value: '/scripts/' });

					if (!directory.tasks)
						opt.items.push({ name: '<strong>@(Create):</strong> /tasks', icon: '!ti ti-folder', value: '/tasks/' });

					if (!directory.themes)
						opt.items.push({ name: '<strong>@(Create):</strong> /themes', icon: '!ti ti-folder', value: '/themes/' });

					if (!directory.threads)
						opt.items.push({ name: '<strong>@(Create):</strong> /threads', icon: '!ti ti-folder', value: '/threads/' });*/

					if (!directory.templates)
						opt.items.push({ name: '<strong>@(Create):</strong> /templates', icon: '!ti ti-folder', value: '/templates/' });

					if (!directory.views)
						opt.items.push({ name: '<strong>@(Create):</strong> /views', icon: '!ti ti-folder', value: '/views/' });

					if (!directory.updates)
						opt.items.push({ name: '<strong>@(Create):</strong> /updates', icon: '!ti ti-folder', value: '/updates/' });

					if (!directory.workers)
						opt.items.push({ name: '<strong>@(Create):</strong> /workers', icon: '!ti ti-folder', value: '/workers/' });

					if (!directory.flowstreams)
						opt.items.push({ name: '<strong>@(Create):</strong> /flowstreams', icon: '!ti ti-folder', value: '/flowstreams/' });

					opt.callback = function(item) {
						exports.statusform('directory', item.value);
						SET('code.statusform.name', '');
					};

					if (opt.items.length)
						SETTER('menu/show', opt);

				} else if (dname === 'file') {
					opt = {};
					opt.element = name;
					opt.offsetY = -1;
					opt.offsetX = 10;
					opt.position = 'bottom';
					opt.items = [];

					var files = {};

					for (var i = 0; i < code.tree.length; i++)
						files[code.tree[i].name] = 1;

					if (!files['.bundleignore'])
						opt.items.push({ name: '<strong>@(Create):</strong> /.bundleignore', icon: '!ti ti-file', value: '/.bundleignore' });

					if (!files['.gitignore'])
						opt.items.push({ name: '<strong>@(Create):</strong> /.gitignore', icon: '!ti ti-file', value: '/.gitignore' });

					if (!files['bundles.debug'])
						opt.items.push({ name: '<strong>@(Create):</strong> /bundles.debug', icon: '!ti ti-file', value: '/bundles.debug' });

					if (!files.config)
						opt.items.push({ name: '<strong>@(Create):</strong> /config', icon: '!ti ti-file', value: '/config' });

					if (!files.Dockerfile)
						opt.items.push({ name: '<strong>@(Create):</strong> /Dockefile', icon: '!ti ti-file', value: '/Dockerfile' });

					if (!files['index.js'])
						opt.items.push({ name: '<strong>@(Create):</strong> /index.js', icon: '!ti ti-file', value: '/index.js' });

					if (!files['license.txt'])
						opt.items.push({ name: '<strong>@(Create):</strong> /license.txt', icon: '!ti ti-file', value: '/license.txt' });

					if (!files['package.json'])
						opt.items.push({ name: '<strong>@(Create):</strong> /package.json', icon: '!ti ti-file', value: '/package.json' });

					if (!files['openplatform.json'])
						opt.items.push({ name: '<strong>@(Create):</strong> /openplatform.json', icon: '!ti ti-file', value: '/openplatform.json' });

					if (!files['readme.api'])
						opt.items.push({ name: '<strong>@(Create):</strong> /readme.api', icon: '!ti ti-file', value: '/readme.api' });

					if (!files['readme.md'])
						opt.items.push({ name: '<strong>@(Create):</strong> /readme.md', icon: '!ti ti-file', value: '/readme.md' });

					if (!files['readme.todo'])
						opt.items.push({ name: '<strong>@(Create):</strong> /readme.todo', icon: '!ti ti-file', value: '/readme.todo' });

					opt.callback = function(item) {
						exports.statusform('file', item.value);
						SET('code.statusform.name', '');
					};

					if (opt.items.length)
						SETTER('menu/show', opt);
				}

				// element
				SET('code.statusform.path', '');
				SET('code.statusform.name', dname);
				var tmp = $('.extrabutton[data-name="reset"]');
				if (tmp.length)
					code.statusform.path = tmp.text();
				return;
			}

			if (!value)
				return;

			var data = {};

			data.path = FUNC.cleanpath((code.statusform.path || '') + value);
			data.folder = name !== 'file';
			data.clone = type;

			SETTER('!menu/hide');
			SETTER('loading/show');
			AJAX('POST /api/files/{id}/create/'.arg(code.data), data, function(response) {
				SETTER('loading/hide', 500);
				if (response.success)
					SETTER('websocket/send', { TYPE: 'refresh', id: code.data.id });
				else
					FUNC.warning(response);
			});
		};

		exports.appendcolor = function(el) {
			var color = el.attrd('color');
			color && editor.editor.replaceSelection(color);
		};

		exports.usersonline = function(el) {

			if (common.isinfopanel) {
				SETTER('infopanel/hide');
				return;
			}

			AJAX('GET /api/users/online/', function(response) {
				response.length && SETTER('infopanel/show', el, function(el) {
					common.isinfopanel = true;
					var builder = [];
					for (var i = 0; i < 10; i++) {
						var user = response[i];
						if (user == null)
							break;
						builder.push('<div class="infopanel-online">{0}<div><b>{1}</b><span>{2}</span></div></div>'.format(Thelpers.initials(user.name), user.name, user.project || '@(No file open)'));
					}

					!builder.length && FUNC.warning('@(No-one works.)');
					el.html(builder.join(''));
				}, 0, -20, null, function() {
					common.isinfopanel = false;
				});
			});
		};

		exports.warnings = function(el, e) {
			if (common.isinfopanel)
				return;
			SETTER('infopanel/show', el, function(el) {
				var builder = [];
				for (var i = 0; i < 10; i++) {
					var err = code.errors && code.errors[i];
					err && builder.push('<div class="infopanel-line exec" data-exec="code/warnings_goto" data-pos="{1}x{2}"><b>:{1}</b><span>{0}</span></div>'.format(err.reason || err.raw, err.line, err.character));
				}
				if (builder.length)
					common.isinfopanel = true;
				else
					FUNC.warning('@(File doesn\'t contain any warnings.)');
				el.html(builder.join(''));
			}, 0, 0, null, function() {
				common.isinfopanel = false;
			});
		};

		exports.warnings_goto = function(el) {
			var pos = el.attrd('pos').split('x');
			editor.editor.setCursor({ line: +pos[0] - 1, char: +pos[1] }, 200);
			editor.editor.focus();
		};

		exports.cursorposition = function(editor) {

			var a = editor.getCursor(true);
			var b = editor.getCursor(false);

			code.cursor.fline = a.line;
			code.cursor.fch = a.ch;
			code.cursor.tline = b.line;
			code.cursor.tch = b.ch;

			if (code.usersfile.length > 1 && code.SYNC) {
				code.cursor.projectid = code.projectid;
				setTimeout2('cursorposition', function() {
					FUNC.wssend(code.cursor);
				}, 300);
			}

			BIND('code.cursor');

			setTimeout2('savescrollposition', function(editor) {
				if (!code.editor.loaded || code.issyncing || !code.editor.loadedcache)
					return;
				var info = editor.getScrollInfo();
				var key = code.projectid + '_scroll';
				if (info.left || info.top || a.line) {
					cache_scrollpos.x = info.left;
					cache_scrollpos.y = info.top;
					cache_scrollpos.line = a.line;
					cache_scrollpos.ch = a.ch;
					localStorage.setItem(key, STRINGIFY(cache_scrollpos));
				} else
					localStorage.removeItem(key);
			}, 300, null, editor);
		};

		WATCH('common.form', function(path, value) {
			$(document.body).tclass('codepanel', !!value);
		});

		exports.tablocked = function() {
			if (!code.current.skip) {
				code.current.skip = true;
				exports.element.FIND('tabmenu').element.find('span[data-value="{0}"]'.format(code.current.path)).rclass('nolocked');
			}
		};

		// Internal cache
		// For unexpect of closing browser
		exports.cache_set = function() {
			if (code.editor.path) {
				var key = code.data.id + '_' + code.editor.hash;
				localStorage.setItem(key, code.editor.body);
			}
		};

		exports.cache_get = function(path) {
			if (path) {
				var key = code.data.id + '_' + HASH(path);
				return localStorage.getItem(key);
			}
		};

		exports.cache_getscroll = function(path) {
			if (path) {
				var key = code.projectid + '_scroll';
				var obj = localStorage.getItem(key);
				return obj ? PARSE(obj) : null;
			}
		};

		exports.cache_rem = function() {
			if (code.editor.path) {
				var key = code.data.id + '_' + HASH(code.editor.path);
				localStorage.removeItem(key);
			}
		};

		exports.timespent = function() {
			SET('common.form', 'timespentform');
		};

		exports.clipboard = function() {
			TOGGLE('common.clipboard');
		};

		exports.makewiki = function() {
			var body = [];
			SETTER('loading/show');
			code.data.files.wait(function(item, next) {
				if ((/controllers|schemas|extensions|plugins\/[a-z0-9_-]+\.html/).test(item)) {
					SETTER('loading/show', '@(Analyzing:) ' + item);
					AJAX('GET /api/projects/{id}/edit/'.arg(code.data), { path: item }, function(response) {
						body.push(response);
						next();
					});
				} else
					next();

			}, function() {
				body = FUNC.makedocs(body.join('\n\n'));
				body = '# Wiki: __' + code.data.name + '__\n\n- URL address: <' + code.data.url + '>\n- Author: __' + user.name + '__\n- Updated: `' + NOW.format('yyyy-MM-dd HH:mm') + '`\n\n\n## __REST API__ endpoints\n\n' + body;
				SETTER('loading/show', '@(Saving...)');
				AJAX('POST /api/projects/{id}/wiki/'.arg(code.data), { body: body }, function(response) {
					SETTER('clipboard/copy', 'https://docs.totaljs.com/?url=' + location.origin + '/wiki/' + response.value + '/');
					SETTER('notifybar/success', '@(Wiki has been created and copied into the clipboard)');
					SETTER('loading/hide');
				});
			});
		};

		exports.docker = function(el) {

			var model = exports.model;
			var opt = {};
			opt.offsetX = 10;
			opt.offsetY = -5;
			opt.element = el;
			opt.large = true;

			SETTER('loading/show', '@(Loading docker state ...)');
			AJAX('GET /api/docker/{id}/ ERROR'.arg(model.data), function(response) {
				var is = response && response.items.length > 0;
				opt.align = 'right';
				opt.custom = '<div style="margin-bottom:8px"><img src="/img/docker.png" style="width:180px;border-radius:var(--radius) var(--radius) 0 0" /></div>';

				if (response && is && response.stats)
					opt.custom += '<div class="docker-info">{0}% <span>{1} MB</span></div>'.format(response.stats.cpu, response.stats.mem.format(1));

				opt.items = [];
				opt.offsetX = -1;
				opt.items.push({ id: 'app', name: is ? '@(<strong>Stop</strong> docker)' : '@(<strong>Run</strong> docker)', icon: is ? 'ti ti-stop-alt red' : 'ti ti-play-alt green' });
				is && opt.items.push({ id: 'restart', name: '@(<strong>Restart</strong> docker)', icon: 'ti ti-refresh' });
				opt.callback = function(sel) {
					var data = {};
					data.id = model.data.id;
					data.type = sel.id === 'restart' ? 'restart' : is ? 'stop' : 'start';

					var done = function() {
						AJAX('POST /api/docker/state/ @showloading ERROR', data, function() {
							if ((data.type === 'restart' || data.type === 'start'))
								EXEC('code/refresh');
							SETTER('loading/hide');
						});
					};
					if (data.type === 'start')
						SETTER('approve/show', '@(Are you sure you want to start a Docker container?)', '"ti ti-play-alt" @(Start)', done);
					else if (data.type === 'restart')
						SETTER('approve/show', '@(Are you sure you want to restart a Docker container?)', '"ti ti-refresh" @(Restart)', done);
					else
						done();
				};

				SETTER('loading/hide', 500);
				SETTER('menu/show', opt);
			});
		};

		exports.review = function(el) {

			if (common.token === '1234567890') {
				SETTER('message/warning', '@(You have invalid token for code review. More info: info@totaljs.com).');
				return;
			}

			if (!code.data.review) {
				SETTER('message/warning', '@(You do not have defined a <b>token</b> for code review. Click on the <b>Settings</b> button and set the token.)');
				return;
			}

			SETTER('approve/show', '@(Are you sure you want to send this file for <b>Code Review</b>?)', '"check-circle" @(Review code) #98BF61', function() {
				AJAX('GET /api/projects/{id}/review/?path='.arg(code.data) + encodeURIComponent(code.editor.path), FUNC.messageresponse('<b><i class="ti ti-check mr5 green"></i>@(DONE)</b><br />@(File has been sent for code review successfully.)'));
			});
		};

		exports.diff = function(el) {

			var changes = code.current.changes;
			var curr = code.current;
			var line = editor.editor.getCursor().line;
			var type = el.attr('name');
			var next = -1;

			if (type === 'prev')
				line--;
			else
				line++;

			for (var i = 0; i < changes.length; i++) {
				var chl = changes[i];
				if (chl === line) {
					next = i;
					break;
				}
			}

			if (next === -1) {

				if (type === 'next') {
					for (var i = 0; i < changes.length; i++) {
						var chl = changes[i];
						if (chl >= line) {
							next = i;
							break;
						}
					}
				} else {
					for (var i = changes.length; i > -1; i--) {
						var chl = changes[i];
						if (chl <= line) {
							next = i;
							break;
						}
					}
				}

				if (next === -1)
					next = changes[type === 'prev' ? changes.length - 1 : 0];
				else
					next = changes[next];

			} else {

				if (type === 'next') {
					next = changes[next + 1];
					if (next == null)
						next = changes[0];
				} else {
					next = changes[next - 1];
					if (next == null)
						next = changes[changes.length - 1];
				}

				if (next == null)
					next = -1;
			}

			if (next > -1)
				editor.editor.setCursor({ line: next - 1, ch: 0 });
		};

		WATCH('common.powermode', function(path, value) {
			SETTER(true, 'editor/reconfigure', 'powermode:' + (value ? '1' : '0'));
			BIND('code.editor.path');
		}, true);

		WATCH('common.clipboard', function(path, value) {
			var is = value === true;
			if (is) {

				if (windows.findItem('id', 'clipboard')) {
					watchlogfile();
					SETTER('windows/show', 'clipboard');
					return;
				}

				var obj = {};
				obj.id = 'clipboard';
				obj.offset = { x: 270, y: WH - 350, width: WW - 300, height: 250, minwidth: 200, minheight: 200 };
				obj.title = '<i class="ti ti-clipboard"></i>@(Clipboard)';
				obj.hidden = false;
				obj.resize = clipboardresize;
				obj.html = '<div data-import="url:/partial/clipboard.html;reevaluate:1" style="width:100%;height:100%"></div>'.format(Date.now());
				obj.actions = { minimize: true, maximize: true, move: true, resize: true, autosave: true, menu: false, hide: true };
				obj.destroy = function() {
					SET('common.clipboard', false);
				};
				PUSH('windows', obj);
			} else
				SETTER('windows/hide', 'clipboard');

		}, true);

		WATCH('code.current.diff', function(path, value) {

			if (!value)
				return;

			var users = {};
			for (var i = 0; i < code.data.users.length; i++) {
				var usr = code.data.users[i];
				users[usr.id] = usr.name;
			}

			for (var i = 0; i < value.length; i++) {
				var diff = value[i];
				editor.diffuser(diff.line - 1, diff.userid, users[diff.userid] || '', diff.updated);
			}
		});

		var iscolor = false;

		$(document).on('mousedown', '.cm-atom', function(e) {
			var html = this.innerHTML;
			if (html.charAt(0) === '#') {
				$('#currentcolor').css('background-color', html).attrd('color', html).rclass('hidden');
				iscolor = true;
				setTimeout2('iscolor', function() {
					iscolor = false;
				}, 500);
			}
		}).on('mousedown', function(e) {
			if (!iscolor) {
				if (e.target.id === 'currentcolor')
					SETTER('clipboard/copy', e.target.getAttribute('data-color'));
				$('#currentcolor').aclass('hidden');
			}
		});
	});

</script>